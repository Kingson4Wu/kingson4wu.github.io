<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="拉巴力的纸皮箱" type="application/atom+xml" />






<meta name="description" content="为啥不吃三文鱼">
<meta property="og:type" content="website">
<meta property="og:title" content="拉巴力的纸皮箱">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="拉巴力的纸皮箱">
<meta property="og:description" content="为啥不吃三文鱼">
<meta property="og:locale">
<meta property="article:author" content="Kingson Wu">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/8/"/>





  <title>拉巴力的纸皮箱</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">拉巴力的纸皮箱</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/04/01/20220401-java-dai-ma-duan-cha-yue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/04/01/20220401-java-dai-ma-duan-cha-yue/" itemprop="url">Java代码段查阅</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-04-01T16:04:14+08:00">
                2022-04-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="集合处理"><a href="#集合处理" class="headerlink" title="集合处理"></a>集合处理</h2><h3 id="List集合拼接成以逗号分隔的字符串"><a href="#List集合拼接成以逗号分隔的字符串" class="headerlink" title="List集合拼接成以逗号分隔的字符串"></a>List集合拼接成以逗号分隔的字符串</h3><ol>
<li><code>list.stream().collect(Collectors.joining(&quot;,&quot;));</code></li>
<li><code>String.join(&quot;,&quot;, list)</code></li>
</ol>
<h3 id="两个List集合取交集"><a href="#两个List集合取交集" class="headerlink" title="两个List集合取交集"></a>两个List集合取交集</h3><ul>
<li><code>list1.retainAll(list2)</code></li>
</ul>
<h3 id="交集、并集、差集"><a href="#交集、并集、差集" class="headerlink" title="交集、并集、差集"></a>交集、并集、差集</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*交集*/</span></span><br><span class="line">List&lt;AClass&gt; intersectResult = aClassList1.stream().filter(aClassList2::contains).collect(Collectors.toList());</span><br><span class="line"><span class="comment">/*并集*/</span></span><br><span class="line">Stream.of(list1, list2).flatMap(Collection::stream).collect(Collectors.toList());</span><br><span class="line"><span class="comment">/*差集*/</span></span><br><span class="line">List&lt;AClass&gt; differenceResult = aClassList1.stream().filter(x -&gt; !aClassList2.contains(x)).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<h3 id="使用parallelStream时要注意线程安全问题"><a href="#使用parallelStream时要注意线程安全问题" class="headerlink" title="使用parallelStream时要注意线程安全问题"></a>使用parallelStream时要注意线程安全问题</h3><ul>
<li>在并发时使用HashMap和ArrayList等非线程安全的类是会存在问题的</li>
<li>应使用<ol>
<li>list合并：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Stream.of().parallel()</span><br><span class="line">           .mapToObj(index -&gt; &#123;</span><br><span class="line">               <span class="keyword">return</span> Collections.&lt;T&gt;emptyList();</span><br><span class="line">           &#125;).flatMap(Collection::stream).collect(Collectors.toList());</span><br></pre></td></tr></table></figure></li>
<li>map合并：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Stream.of().parallel()</span><br><span class="line">           .mapToObj(index -&gt; &#123;</span><br><span class="line">               <span class="keyword">return</span> Collections.&lt;K, V&gt;emptyMap();</span><br><span class="line">           &#125;)</span><br><span class="line">					.flatMap(x -&gt; x.entrySet().stream())</span><br><span class="line">					.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, (v1, v2) -&gt; v1));</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><ul>
<li><code>list.sort(Comparator.comparing(XXX::getXX, Comparator.reverseOrder()).thenComparing(XXX::getXXX))</code></li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">list.sort(</span><br><span class="line">            Comparator.comparing((Function&lt;XXXBO, Integer&gt;)xxxBO -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (ids.contains(xxxBO.getId())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;).thenComparing(xxxBO -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (ptIds.contains(xxxBO.getTId())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;)</span><br><span class="line">                .thenComparing(XXXBO::getAddTime, Comparator.reverseOrder())</span><br><span class="line">                    .thenComparing(XXXBO::getId, Comparator.reverseOrder()));</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><h3 id="首字母转成大写"><a href="#首字母转成大写" class="headerlink" title="首字母转成大写"></a>首字母转成大写</h3><ul>
<li><code>StringUtils.capitalize(str);</code></li>
</ul>
<h3 id="重复拼接字符串"><a href="#重复拼接字符串" class="headerlink" title="重复拼接字符串"></a>重复拼接字符串</h3><ul>
<li><code>StringUtils.repeat(&quot;ab&quot;, 2);</code></li>
</ul>
<h3 id="字符串分割"><a href="#字符串分割" class="headerlink" title="字符串分割"></a>字符串分割</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Iterable&lt;String&gt; split = Splitter.on(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">							 .trimResults()</span><br><span class="line">							 .omitEmptyStrings()</span><br><span class="line">							 .split(sourceStr);</span><br><span class="line">			 <span class="keyword">return</span> Sets.newHashSet(split)</span><br><span class="line"></span><br><span class="line">Sets.newHashSet(Splitter.on(<span class="string">&quot;,&quot;</span>).omitEmptyStrings().trimResults().splitToList(topics));</span><br></pre></td></tr></table></figure>

<h2 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h2><h3 id="Date类型转String类型"><a href="#Date类型转String类型" class="headerlink" title="Date类型转String类型"></a>Date类型转String类型</h3><ul>
<li><code>String date = DateFormatUtils.format(new Date(), &quot;yyyy-MM-dd HH:mm:ss&quot;);</code></li>
</ul>
<h3 id="String类型转Date类型"><a href="#String类型转Date类型" class="headerlink" title="String类型转Date类型"></a>String类型转Date类型</h3><ul>
<li><code>Date date = DateUtils.parseDate(&quot;2021-05-01 01:01:01&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;);</code></li>
</ul>
<h3 id="计算一个小时后的日期"><a href="#计算一个小时后的日期" class="headerlink" title="计算一个小时后的日期"></a>计算一个小时后的日期</h3><ul>
<li><code>Date date = DateUtils.addHours(new Date(), 1);</code></li>
</ul>
<h3 id="java8"><a href="#java8" class="headerlink" title="java8"></a>java8</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">tomorrowZeroTime</span> <span class="operator">=</span> LocalDate.now().plusDays(<span class="number">1</span>).atTime(LocalTime.MIN).atZone(ZoneId.systemDefault()).toEpochSecond();</span><br><span class="line"> <span class="type">long</span> <span class="variable">days</span> <span class="operator">=</span> (expireZeroTime - nowZeroTime) / SECONDS_PER_DAY;</span><br><span class="line"> <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.now().plusHours(-<span class="number">2</span>).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();</span><br><span class="line"> <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.now().plusHours(-<span class="number">1</span>).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();</span><br><span class="line"> <span class="type">long</span> <span class="variable">exportStartTime</span> <span class="operator">=</span> LocalDateTime.of(LocalDate.now(), LocalTime.MIN).minusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault()).toEpochSecond();</span><br><span class="line"> <span class="type">long</span> <span class="variable">exportStartTime</span> <span class="operator">=</span>LocalDateTime.now().withHours(<span class="number">0</span>).plusHours(-<span class="number">1</span>).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();</span><br><span class="line"> <span class="type">Long</span> <span class="variable">millisecond</span> <span class="operator">=</span> Instant.now().toEpochMilli();  <span class="comment">// 精确到毫秒</span></span><br><span class="line"> <span class="type">Long</span> <span class="variable">second</span> <span class="operator">=</span> Instant.now().getEpochSecond();<span class="comment">// 精确到秒</span></span><br><span class="line"> LocalDateTime.ofInstant(Instant.ofEpochMilli(time),ZoneId.systemDefault())</span><br><span class="line">  <span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line">             <span class="type">LocalDate</span> <span class="variable">dt</span> <span class="operator">=</span> LocalDate.parse(<span class="string">&quot;20191020&quot;</span>, formatter);</span><br><span class="line">             dt.plusDays(<span class="number">1</span>);</span><br><span class="line">             <span class="type">String</span> <span class="variable">day</span> <span class="operator">=</span> dt.format(formatter);</span><br><span class="line">  <span class="comment">//Java8的DateTimeFormatter是线程安全的，而SimpleDateFormat并不是线程安全。    </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="开源库"><a href="#开源库" class="headerlink" title="开源库"></a>开源库</h2><h3 id="commons-collections4"><a href="#commons-collections4" class="headerlink" title="commons-collections4"></a>commons-collections4</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两个集合取交集</span></span><br><span class="line">Collection&lt;String&gt; collection = CollectionUtils.retainAll(listA, listB);</span><br><span class="line"><span class="comment">// 两个集合取并集</span></span><br><span class="line">Collection&lt;String&gt; collection = CollectionUtils.union(listA, listB);</span><br><span class="line"><span class="comment">// 两个集合取差集</span></span><br><span class="line">Collection&lt;String&gt; collection = CollectionUtils.subtract(listA, listB);</span><br></pre></td></tr></table></figure>

<h3 id="common-beanutils-操作对象"><a href="#common-beanutils-操作对象" class="headerlink" title="common-beanutils 操作对象"></a>common-beanutils 操作对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">BeanUtils.setProperty(user, <span class="string">&quot;id&quot;</span>, <span class="number">1</span>);</span><br><span class="line">BeanUtils.setProperty(user, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;yideng&quot;</span>);</span><br><span class="line">System.out.println(BeanUtils.getProperty(user, <span class="string">&quot;name&quot;</span>)); <span class="comment">// 输出 yideng</span></span><br><span class="line">System.out.println(user); <span class="comment">// 输出 &#123;&quot;id&quot;:1,&quot;name&quot;:&quot;yideng&quot;&#125;</span></span><br><span class="line">对象和map互转</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象转map</span></span><br><span class="line">Map&lt;String, String&gt; map = BeanUtils.describe(user);</span><br><span class="line">System.out.println(map); <span class="comment">// 输出 &#123;&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;yideng&quot;&#125;</span></span><br><span class="line"><span class="comment">// map转对象</span></span><br><span class="line"><span class="type">User</span> <span class="variable">newUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">BeanUtils.populate(newUser, map);</span><br><span class="line">System.out.println(newUser); <span class="comment">// 输出 &#123;&quot;id&quot;:1,&quot;name&quot;:&quot;yideng&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="commons-io-文件流处理"><a href="#commons-io-文件流处理" class="headerlink" title="commons-io 文件流处理"></a>commons-io 文件流处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;demo1.txt&quot;</span>);</span><br><span class="line"><span class="comment">// 读取文件</span></span><br><span class="line">List&lt;String&gt; lines = FileUtils.readLines(file, Charset.defaultCharset());</span><br><span class="line"></span><br><span class="line">FileUtils.readFileToString(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;xxx&quot;</span>));</span><br><span class="line"><span class="comment">// 写入文件</span></span><br><span class="line">FileUtils.writeLines(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;demo2.txt&quot;</span>), lines);</span><br><span class="line"><span class="comment">// 复制文件</span></span><br><span class="line">FileUtils.copyFile(srcFile, destFile);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Google-Guava-工具类库"><a href="#Google-Guava-工具类库" class="headerlink" title="Google Guava 工具类库"></a>Google Guava 工具类库</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建集合</span></span><br><span class="line">List&lt;String&gt; list = Lists.newArrayList();</span><br><span class="line">List&lt;Integer&gt; list = Lists.newArrayList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// 反转list</span></span><br><span class="line">List&lt;Integer&gt; reverse = Lists.reverse(list);</span><br><span class="line">System.out.println(reverse); <span class="comment">// 输出 [3, 2, 1]</span></span><br><span class="line"><span class="comment">// list集合元素太多，可以分成若干个集合，每个集合10个元素</span></span><br><span class="line">List&lt;List&lt;Integer&gt;&gt; partition = Lists.partition(list, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;String, String&gt; map = Maps.newHashMap();</span><br><span class="line">Set&lt;String&gt; set = Sets.newHashSet();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Multimap 一个key可以映射多个value的HashMap</span></span><br><span class="line">Multimap&lt;String, Integer&gt; map = ArrayListMultimap.create();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>, <span class="number">1</span>);</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>, <span class="number">2</span>);</span><br><span class="line">Collection&lt;Integer&gt; values = map.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">System.out.println(map); <span class="comment">// 输出 &#123;&quot;key&quot;:[1,2]&#125;</span></span><br><span class="line"><span class="comment">// 还能返回你以前使用的臃肿的Map</span></span><br><span class="line">Map&lt;String, Collection&lt;Integer&gt;&gt; collectionMap = map.asMap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//BiMap 一种连value也不能重复的HashMap</span></span><br><span class="line">BiMap&lt;String, String&gt; biMap = HashBiMap.create();</span><br><span class="line"><span class="comment">// 如果value重复，put方法会抛异常，除非用forcePut方法</span></span><br><span class="line">biMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">System.out.println(biMap); <span class="comment">// 输出 &#123;&quot;key&quot;:&quot;value&quot;&#125;</span></span><br><span class="line"><span class="comment">// 既然value不能重复，何不实现个翻转key/value的方法，已经有了</span></span><br><span class="line">BiMap&lt;String, String&gt; inverse = biMap.inverse();</span><br><span class="line">System.out.println(inverse); <span class="comment">// 输出 &#123;&quot;value&quot;:&quot;key&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Table 一种有两个key的HashMap</span></span><br><span class="line"><span class="comment">// 一批用户，同时按年龄和性别分组</span></span><br><span class="line">Table&lt;Integer, String, String&gt; table = HashBasedTable.create();</span><br><span class="line">table.put(<span class="number">18</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;yideng&quot;</span>);</span><br><span class="line">table.put(<span class="number">18</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;Lily&quot;</span>);</span><br><span class="line">System.out.println(table.get(<span class="number">18</span>, <span class="string">&quot;男&quot;</span>)); <span class="comment">// 输出 yideng</span></span><br><span class="line"><span class="comment">// 这其实是一个二维的Map，可以查看行数据</span></span><br><span class="line">Map&lt;String, String&gt; row = table.row(<span class="number">18</span>);</span><br><span class="line">System.out.println(row); <span class="comment">// 输出 &#123;&quot;男&quot;:&quot;yideng&quot;,&quot;女&quot;:&quot;Lily&quot;&#125;</span></span><br><span class="line"><span class="comment">// 查看列数据</span></span><br><span class="line">Map&lt;Integer, String&gt; column = table.column(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">System.out.println(column); <span class="comment">// 输出 &#123;18:&quot;yideng&quot;&#125;</span></span><br><span class="line"><span class="comment">// Multiset 一种用来计数的Set</span></span><br><span class="line">Multiset&lt;String&gt; multiset = HashMultiset.create();</span><br><span class="line">multiset.add(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">multiset.add(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">multiset.add(<span class="string">&quot;orange&quot;</span>);</span><br><span class="line">System.out.println(multiset.count(<span class="string">&quot;apple&quot;</span>)); <span class="comment">// 输出 2</span></span><br><span class="line"><span class="comment">// 查看去重的元素</span></span><br><span class="line">Set&lt;String&gt; set = multiset.elementSet();</span><br><span class="line">System.out.println(set); <span class="comment">// 输出 [&quot;orange&quot;,&quot;apple&quot;]</span></span><br><span class="line"><span class="comment">// 还能查看没有去重的元素</span></span><br><span class="line">Iterator&lt;String&gt; iterator = multiset.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    System.out.println(iterator.next());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 还能手动设置某个元素出现的次数</span></span><br><span class="line">multiset.setCount(<span class="string">&quot;apple&quot;</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="比较两个对象是否相等"><a href="#比较两个对象是否相等" class="headerlink" title="比较两个对象是否相等"></a>比较两个对象是否相等</h3><ul>
<li><code>Objects.equals(strA, strB);</code> (防止空指针)</li>
</ul>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>1. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(</span><br><span class="line">                  () -&gt; &#123;</span><br><span class="line">                  &#125;);</span><br></pre></td></tr></table></figure>

<p>2. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="重写toString"><a href="#重写toString" class="headerlink" title="重写toString"></a>重写toString</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">  		<span class="keyword">return</span> ReflectionToStringBuilder.toString(<span class="built_in">this</span>,</span><br><span class="line">  				ToStringStyle.SHORT_PREFIX_STYLE);</span><br><span class="line">&#125;</span><br><span class="line">  	</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="type">ReflectionToStringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionToStringBuilder</span>(</span><br><span class="line">                  <span class="built_in">this</span>, ToStringStyle.SHORT_PREFIX_STYLE) &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">accept</span><span class="params">(Field field)</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> !<span class="string">&quot;createTime&quot;</span>.equals(field.getName()) &amp;&amp;</span><br><span class="line">                          !field.getName().equals(<span class="string">&quot;updateTime&quot;</span>) &amp;&amp;</span><br><span class="line">                          !field.getName().equals(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125; 	</span><br></pre></td></tr></table></figure>

<h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; requestMap =</span><br><span class="line">            request.getParameterMap().entrySet().stream().collect(</span><br><span class="line">                Collectors.toMap(Map.Entry::getKey, entry -&gt; entry.getValue()[<span class="number">0</span>], (v1, v2) -&gt; &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(String.format(<span class="string">&quot;Duplicate key for values %s and %s&quot;</span>, v1, v2));</span><br><span class="line">                    &#125;,</span><br><span class="line">                    TreeMap::<span class="keyword">new</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ContextedRuntimeException</span>(<span class="string">&quot;notExist&quot;</span>).addContextValue(<span class="string">&quot;id&quot;</span>, id));</span><br></pre></td></tr></table></figure>

<h4 id="Optional中map和flatMap"><a href="#Optional中map和flatMap" class="headerlink" title="Optional中map和flatMap"></a>Optional中map和flatMap</h4><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_28988969/article/details/80995927">https://blog.csdn.net/qq_28988969/article/details/80995927</a></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FlightTicketInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * desc :</span></span><br><span class="line"><span class="comment"> * create_user : cheng</span></span><br><span class="line"><span class="comment"> * create_date : 2018/7/4 11:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptionalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FlightTicketInfo</span> <span class="variable">flightTicketInfo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        Optional&lt;Optional&lt;String&gt;&gt; s1 = Optional.ofNullable(flightTicketInfo).map(OptionalTest::getOrderNumber);</span><br><span class="line"></span><br><span class="line">        Optional&lt;String&gt; s2 = Optional.ofNullable(flightTicketInfo).map(FlightTicketInfo::getOrderNumber);</span><br><span class="line"></span><br><span class="line">        Optional&lt;String&gt; s3 = Optional.ofNullable(flightTicketInfo).flatMap(OptionalTest::getOrderNumber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Optional&lt;String&gt; <span class="title function_">getOrderNumber</span><span class="params">(FlightTicketInfo flightTicketInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(flightTicketInfo).map(f -&gt; f.getOrderNumber());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>1.9新增 or()方法是作为orElse()和orElseGet()方法的改进而出现的，使用方法一致，但后两个方法在执行完成后返回的并非包装值。如果需要执行一些逻辑并返回Optional时，可以使用or()方法。该方法传入Supplier接口的实例，当value有值时直接返回自身Optional，当为空时，自动执行suuplier的get()方法，并包装成Optional返回，其源码中包装的语句如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;T&gt; r = (Optional&lt;T&gt;) supplier.get();</span><br><span class="line"><span class="keyword">return</span> Objects.requireNonNull(r);</span><br></pre></td></tr></table></figure>
<ul>
<li>stream()方法则不用多说，是一个提供给流式编程使用的方法，功能上是一个适配器，将Optional转换成Stream：没有值返回一个空的stream，或者包含一个Optional的stream。其源码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isPresent()) &#123;</span><br><span class="line"><span class="keyword">return</span> Stream.empty();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Stream.of(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其原因是orElseGet()的参数是Supplier目标类型的函数，简单来说，Suppiler接口类似Spring的懒加载，声明之后并不会占用内存，只有执行了get()方法之后，才会调用构造方法创建出对象，而orElse()是快加载，即使没有调用，也会实际的运行。<br>这个特性在一些简单的方法上差距不大，但是当方法是一些执行密集型的调用时，比如远程调用，计算类或者查询类方法时，会损耗一定的性能。<br>orElseThrow()方法与orElseGet()方法的参数都是Supplier参数都是函数类型的，这意味着这两种方法都是懒加载，但针对于必须要使用异常控制流程的场景，orElseThrow()会更加合适，因为可以控制异常类型，使得相比NPE会有更丰富的语义。</li>
</ul>
<h3 id="BigDecimal"><a href="#BigDecimal" class="headerlink" title="BigDecimal"></a>BigDecimal</h3><ul>
<li><code>user.getMoney().stripTrailingZeros().toPlainString()</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> BigDecimal <span class="title function_">sum</span><span class="params">(Function&lt;XXX, BigDecimal&gt; get, List&lt;XXX&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.stream().map(get).reduce((acc, item) -&gt; &#123;</span><br><span class="line">            acc = acc.add(item);</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;).get().divide(BigDecimal.valueOf(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="包装临时对象"><a href="#包装临时对象" class="headerlink" title="包装临时对象"></a>包装临时对象</h3><ul>
<li>当一个方法需要返回两个及以上字段时，可以使用Pair和Triple</li>
<li>返回两个字段<br><code>ImmutablePair&lt;Integer, String&gt; pair = ImmutablePair.of(1, &quot;yideng&quot;);</code></li>
<li>返回三个字段<br><code>ImmutableTriple&lt;Integer, String, Date&gt; triple = ImmutableTriple.of(1, &quot;yideng&quot;, new Date());</code></li>
</ul>
<h3 id="临时文件返回"><a href="#临时文件返回" class="headerlink" title="临时文件返回"></a>临时文件返回</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XXXController</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@GetMapping(value = &quot;/xxdata.txt&quot;)</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bidata</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;success|=|333\nsuccess|=|333&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain;charset=utf-8&quot;</span>);</span><br><span class="line">                response.addHeader(<span class="string">&quot;Content-Disposition&quot;</span>,<span class="string">&quot;attachment;filename=xxdata.txt&quot;</span>);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">output</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">                output.write(content.getBytes(Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">                output.flush();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@GetMapping(value = &quot;/xxdata.txt&quot;)</span></span><br><span class="line">     <span class="keyword">public</span> String <span class="title function_">bidata</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line"></span><br><span class="line">                response.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain;charset=utf-8&quot;</span>);</span><br><span class="line">                response.addHeader(<span class="string">&quot;Content-Disposition&quot;</span>,<span class="string">&quot;attachment;filename=xxdata.txt&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>  <span class="string">&quot;success|=|333\nsuccess|=|333&quot;</span>;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/xxvideo/&#123;uri&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">proxy</span><span class="params">(<span class="meta">@PathVariable(&quot;uri&quot;)</span> String uri, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*.xx.cn, *.xx.xx.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">output</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxxService.getRealUrl(uri);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(url)) &#123;</span><br><span class="line">                response.setStatus(HttpStatus.NOT_FOUND_404);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(Proxy.Type.HTTP, <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(forwardProxyHost, forwardProxyPort));</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url).openConnection(proxy).getInputStream()) &#123;</span><br><span class="line">                IOUtils.copy(input, output);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;error，uri:&#123;&#125;&quot;</span>, uri, e);</span><br><span class="line">            response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR_500);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(Runtime.getRuntime().availableProcessors() * <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">BasicThreadFactory</span>.Builder().namingPattern(<span class="string">&quot;common-schedule-pool-%d&quot;</span>).daemon(<span class="literal">true</span>).build()); </span><br></pre></td></tr></table></figure>

<ul>
<li>Java线程池中三种方式创建 ThreadFactory 设置线程名称: <a target="_blank" rel="noopener" href="https://blog.csdn.net/u010648555/article/details/106137206">https://blog.csdn.net/u010648555/article/details/106137206</a></li>
</ul>
<h3 id="扫描注解"><a href="#扫描注解" class="headerlink" title="扫描注解"></a>扫描注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">Reflections</span> <span class="variable">reflections</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reflections</span>(<span class="keyword">new</span> <span class="title class_">ConfigurationBuilder</span>()</span><br><span class="line">               .addUrls(ClasspathHelper.forPackage(<span class="string">&quot;com.xxx&quot;</span>))</span><br><span class="line">               .setScanners(<span class="keyword">new</span> <span class="title class_">MethodAnnotationsScanner</span>()));</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">final</span> Method method : reflections.getMethodsAnnotatedWith(xxxxx.class)) &#123;</span><br><span class="line">           Class&lt;?&gt; clazz = method.getDeclaringClass();</span><br><span class="line">           Collection&lt;?&gt; beans = applicationContext.getBeansOfType(clazz).values();</span><br><span class="line">           <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> beans.size();</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.reflections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reflections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> CompletableFuture&lt;Boolean&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">CompletableFuture&lt;Boolean&gt; future2 = CompletableFuture.supplyAsync(() -&gt; <span class="literal">true</span>);</span><br><span class="line">CompletableFuture&lt;Boolean&gt; future3 = CompletableFuture.supplyAsync(() -&gt; <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Supplier&lt;Boolean&gt;&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        tasks.add(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        tasks.add(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        tasks.stream().parallel().forEach(Supplier::get);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;CallResult&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> CallResult.FAIL;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;CallResult&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> CallResult.FAIL;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">List&lt;CallResult&gt; resultList = Stream.of(future1, future2).map(CompletableFuture::join).collect(</span><br><span class="line">            Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (resultList.stream().filter(v -&gt; CallResult.FAIL.equals(v)).count() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot; call exception&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> IntStream.range(<span class="number">0</span>, DBTableConfig.SIZE).parallel()</span><br><span class="line">  .mapToObj(index -&gt; mapper.selectAllList(index, Date.from(Instant.ofEpochSecond(startTime)),</span><br><span class="line">    Date.from(Instant.ofEpochSecond(endTime)), xxx, Arrays.asList(xx, xx), limit)).flatMap(Collection::stream).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; cf6 = CompletableFuture.allOf(cf3, cf4, cf5);</span><br><span class="line">CompletableFuture&lt;String&gt; result = cf6.thenApply(v -&gt; &#123;</span><br><span class="line">  <span class="comment">//这里的join并不会阻塞，因为传给thenApply的函数是在CF3、CF4、CF5全部完成时，才会执行 。</span></span><br><span class="line">  result3 = cf3.join();</span><br><span class="line">  result4 = cf4.join();</span><br><span class="line">  result5 = cf5.join();</span><br><span class="line">  <span class="comment">//根据result3、result4、result5组装最终result;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="开源类库"><a href="#开源类库" class="headerlink" title="开源类库"></a>开源类库</h2><ul>
<li>apache commons</li>
<li>commons-lang3</li>
<li>commons-collections</li>
</ul>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="keyword">if</span> (requestAttributes <span class="keyword">instanceof</span> ServletRequestAttributes) &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes)requestAttributes).getRequest();</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * curl -XPOST -F &quot;materialFile=@/D:/Downloads/5c1.FBX&quot; &quot;http://127.0.0.1:19201/addMaterial&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> materialFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CheckToken(false)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addMaterial&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApplicationResponse <span class="title function_">addMaterial</span><span class="params">(<span class="meta">@RequestParam(&quot;materialFile&quot;)</span> MultipartFile materialFile</span></span><br><span class="line"><span class="params">            )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApplicationResponse.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">spring.http.multipart.maxFileSize=10MB</span><br><span class="line">spring.http.multipart.maxRequestSize=10MB</span><br></pre></td></tr></table></figure>

<ul>
<li>long 前端失精问题<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(&quot;jackson2ObjectMapperBuilderCustomizer&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;config.long2string&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="title function_">jackson2ObjectMapperBuilderCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Jackson2ObjectMapperBuilderCustomizer</span> <span class="variable">customizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2ObjectMapperBuilderCustomizer</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(Jackson2ObjectMapperBuilder jacksonObjectMapperBuilder)</span> &#123;</span><br><span class="line">            jacksonObjectMapperBuilder.serializerByType(Long.class, ToStringSerializer.instance)</span><br><span class="line">                    .serializerByType(Long.TYPE, ToStringSerializer.instance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> customizer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryBookInfo&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.tjt.platform.entity.BookInfo&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">select count(*) from t_rule_BookInfo t</span><br><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title !=null and title !=&#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">title = #&#123;title&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author !=null and author !=&#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">AND author = #&#123;author&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">UPDATE 操作也一样，可以用标记代替 1=1。</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Select(&#123;</span><br><span class="line">               &quot;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">&quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;SELECT &quot; +  FIELDS,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;FROM  `t_xxxx_task` t&quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;WHERE createTime <span class="symbol">&amp;gt;</span>= #&#123;startTime&#125; AND createTime <span class="symbol">&amp;lt;</span> #&#123;endTime&#125; &quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;<span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span> = <span class="string">&#x27;statusList != null and statusList.size &gt; 0&#x27;</span>&gt;</span>&quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;AND `status` in (<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span> = <span class="string">&#x27;statusList&#x27;</span> <span class="attr">item</span> = <span class="string">&#x27;status&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;index&#x27;</span> <span class="attr">open</span>=<span class="string">&#x27;&#x27;</span> <span class="attr">close</span>=<span class="string">&#x27;&#x27;</span> <span class="attr">separator</span>=<span class="string">&#x27;,&#x27;</span>&gt;</span>#&#123;status&#125;<span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)&quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;<span class="tag">&lt;/<span class="name">when</span>&gt;</span>&quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;LIMIT #&#123;limit&#125;&quot;,</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">               &quot;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>&quot;</span><br><span class="line">       &#125;)</span><br><span class="line">       List<span class="tag">&lt;<span class="name">TxxxxTask</span>&gt;</span> selectList(@Param(&quot;startTime&quot;)Date startTime, @Param(&quot;endTime&quot;)Date endTime, @Param(&quot;statusList&quot;) List<span class="tag">&lt;<span class="name">Integer</span>&gt;</span> statusList, @Param(&quot;limit&quot;) int limit);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.toutiao.com/i6943239541448917512">实现同样逻辑，代码量减少90%，Java程序员必会的工具库</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/515993095">CompletableFuture原理与实践-外卖商家端API的异步化</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/03/22/20220322-qing-liang-ji-wei-fu-wu-gong-gong-ku-she-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/03/22/20220322-qing-liang-ji-wei-fu-wu-gong-gong-ku-she-ji/" itemprop="url">轻量级微服务公共库设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-03-22T16:58:14+08:00">
                2022-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><ul>
<li><p>减少拷贝代码，抽象公共业务组件和复用，快速支持产品需求</p>
</li>
<li><p>提升开发效率，增强排查能力</p>
</li>
<li><p>统一维护，提升代码质量，减少重复错误，提高服务可控性</p>
</li>
<li><p>公共嵌入式的sdk，其实有点类似一个轻量级的网关，sidecar，localproxy</p>
</li>
</ul>
<p><img src="/2022/03/22/20220322-qing-liang-ji-wei-fu-wu-gong-gong-ku-she-ji/common.png"></p>
<ul>
<li>为什么不使用API网关？<ol>
<li>有一定的机器和维护成本</li>
<li>跟组织架构有一定关系</li>
</ol>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/03/12/20220312-guan-yu-qing-liang-ji-fen-bu-shi-shi-jian-tong-zhi-de-si-kao/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/03/12/20220312-guan-yu-qing-liang-ji-fen-bu-shi-shi-jian-tong-zhi-de-si-kao/" itemprop="url">关于轻量级分布式事件通知的思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-03-12T14:03:08+08:00">
                2022-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>有些业务场景，我们需要发出一个事件，通知到每一个进程。<br>比如数据变更，通知每个进程更新本地缓存。</p>
</li>
<li><p>使用MQ的话，以NSQ为例，将channel名设置为ip，那么每个进程都会收到这个事件；但是目前现在是k8s的时代，使用k8s部署进程，那么会导致某些旧ip的channel仍然存在，从而造成事件堆积。</p>
</li>
<li><p>redis虽然支持事件，但是微服务时代，不太建议每个业务的微服务都连同一个redis（同业务内的通知可以考虑）；使用一个公共的zk获取是一个可以考虑的方案，各服务启动时watch相应的节点即可。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/28/20220228-jing-dian-pai-xu-suan-fa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/02/28/20220228-jing-dian-pai-xu-suan-fa/" itemprop="url">经典排序算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-02-28T14:56:23+08:00">
                2022-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/onepixel/articles/7674659.html">十大经典排序算法（动图演示）</a></li>
</ul>
<h2 id="排序算法分类"><a href="#排序算法分类" class="headerlink" title="排序算法分类"></a>排序算法分类</h2><h3 id="一"><a href="#一" class="headerlink" title="(一)"></a>(一)</h3><ul>
<li>内部排序和外部排序</li>
</ul>
<h3 id="（二）"><a href="#（二）" class="headerlink" title="（二）"></a>（二）</h3><ol>
<li>比较类排序：通过比较来决定元素间的相对次序，由于其时间复杂度不能突破O(nlogn)，因此也称为非线性时间比较类排序。(非线性时间)</li>
<li>非比较类排序：不通过比较来决定元素间的相对次序，它可以突破基于比较排序的时间下界，以线性时间运行，因此也称为线性时间非比较类排序。 (线性时间)</li>
</ol>
<h3 id="（三）"><a href="#（三）" class="headerlink" title="（三）"></a>（三）</h3><ol>
<li>非线性时间比较类排序：通过比较来决定元素间的相对次序，由于其时间复杂度不能突破O(nlogn)，因此称为非线性时间比较类排序。如：快速排序、归并排序、堆排序、冒泡排序等。在排序的最终结果里，元素之间的次序依赖于它们之间的比较。每个数都必须和其他数进行比较，才能确定自己的位置。</li>
<li>线性时间非比较类排序：不通过比较来决定元素间的相对次序，它可以突破基于比较排序的时间下界，以线性时间运行，因此称为线性时间非比较类排序。如：计数排序、基数排序、桶排序。非比较排序是通过确定每个元素之前，应该有多少个元素来排序。针对数组arr，计算arr之前有多少个元素，则唯一确定了arr在排序后数组中的位置。</li>
</ol>
<h3 id="（四）"><a href="#（四）" class="headerlink" title="（四）"></a>（四）</h3><ol>
<li>比较类排序<ul>
<li>交换排序 (swap)<ul>
<li>冒泡排序 (bubble Sort) - 双重遍历，相邻元素两两比较交换</li>
<li>快速排序 (quick Sort) - 较复杂</li>
</ul>
</li>
<li>插入排序 (insertion)<ul>
<li>简单插入排序 (insertion sort) - 分左右两批，遍历有序列表，将无序的元素插入有序的列表</li>
<li>希尔排序 (shell sort) (缩小增量排序) - 较复杂</li>
</ul>
</li>
<li>选择排序 (selection)<ul>
<li>简单选择排序 (selection) - 双重遍历，每次找到最小的元素，最后和该趟遍历的第一个元素进行交换</li>
<li>堆排序 (heap sort)</li>
</ul>
</li>
<li>归并排序 (merge sort) - 即先使每个子序列有序，再使子序列段间有序。若将两个有序表合并成一个有序表，称为2-路归并。 （递归）<ul>
<li>二路归并排序</li>
<li>多路归并排序</li>
</ul>
</li>
</ul>
</li>
<li>非比较类排序<ul>
<li>计数排序 (counting sort)</li>
<li>桶排序 (bucket sort)</li>
<li>基数排序 (radix sort)(分配排序)</li>
</ul>
</li>
</ol>
<h3 id="（五）"><a href="#（五）" class="headerlink" title="（五）"></a>（五）</h3><ul>
<li>算法复杂度</li>
</ul>
<table>
<thead>
<tr>
<th>排序方法</th>
<th>时间复杂度（平均）</th>
<th>时间复杂度（最坏）</th>
<th>时间复杂度（最好）</th>
<th>空间复杂度</th>
<th>稳定性</th>
</tr>
</thead>
<tbody><tr>
<td>冒泡排序</td>
<td>O(n^2)</td>
<td>O(n^2)</td>
<td>O(n)</td>
<td>O(1)</td>
<td>稳定</td>
</tr>
<tr>
<td>快速排序</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(n^2)</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>不稳定</td>
</tr>
<tr>
<td>简单插入排序</td>
<td>O(n^2)</td>
<td>O(n^2)</td>
<td>O(n)</td>
<td>O(1)</td>
<td>稳定</td>
</tr>
<tr>
<td>希尔排序</td>
<td>O(n<sup>1.3</sup>)</td>
<td>O(n^2)</td>
<td>O(n)</td>
<td>O(1)</td>
<td>不稳定</td>
</tr>
<tr>
<td>简单选择排序</td>
<td>O(n^2)</td>
<td>O(n^2)</td>
<td>O(n^2)</td>
<td>O(1)</td>
<td>不稳定</td>
</tr>
<tr>
<td>堆排序</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(1)</td>
<td>不稳定</td>
</tr>
<tr>
<td>归并排序</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(nlog<sub>2</sub>n)</td>
<td>O(n)</td>
<td>稳定</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>计数排序</td>
<td>O(n+k)</td>
<td>O(n+k)</td>
<td>O(n+k)</td>
<td>O(n+k)</td>
<td>稳定</td>
</tr>
<tr>
<td>桶排序</td>
<td>O(n+k)</td>
<td>O(n^2)</td>
<td>O(n)</td>
<td>O(n+k)</td>
<td>稳定</td>
</tr>
<tr>
<td>基数排序</td>
<td>O(n*k)</td>
<td>O(n*k)</td>
<td>O(n*k)</td>
<td>O(n+k)</td>
<td>稳定</td>
</tr>
</tbody></table>
<ul>
<li>相关概念：</li>
</ul>
<h4 id="1、时间复杂度"><a href="#1、时间复杂度" class="headerlink" title="1、时间复杂度"></a>1、时间复杂度</h4><ul>
<li>时间复杂度可以认为是对排序数据的总的操作次数。反映当n变化时，操作次数呈现什么规律。</li>
<li>常见的时间复杂度有：常数阶O(1),对数阶O(log2n),线性阶O(n), 线性对数阶O(nlog2n),平方阶O(n2)</li>
<li>时间复杂度O(1)：算法中语句执行次数为一个常数，则时间复杂度为O(1),</li>
</ul>
<h4 id="2、空间复杂度"><a href="#2、空间复杂度" class="headerlink" title="2、空间复杂度"></a>2、空间复杂度</h4><ul>
<li>空间复杂度是指算法在计算机内执行时所需存储空间的度量，它也是问题规模n的函数</li>
<li>空间复杂度O(1)：当一个算法的空间复杂度为一个常量，即不随被处理数据量n的大小而改变时，可表示为O(1)</li>
<li>空间复杂度O(log2N)：当一个算法的空间复杂度与以2为底的n的对数成正比时，可表示为O(log2n)， ax&#x3D;N，则x&#x3D;logaN，</li>
<li>空间复杂度O(n)：当一个算法的空间复杂度与n成线性比例关系时，可表示为0(n).</li>
</ul>
<h4 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h4><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42907443/article/details/118329160">常见排序算法分类（排序算法，是算法的基石，你掌握多少？）</a></li>
<li>大O时间复杂度表示法：表示代码执行时间随数据规模增长的变化趋势，又称渐进时间复杂度</li>
<li>大O空间复杂度表示法：表示代码执行所占的内存空间随数据规模增长的变化趋势，又称渐进空间复杂度</li>
<li>复杂度分析法则<ul>
<li>单段代码，看循环的次数。</li>
<li>多段代码，看代码循环量级。</li>
<li>嵌套代码求乘积，比如递归和多重循环。</li>
<li>多个规模求加法，方法中并行的两个循环。</li>
</ul>
</li>
<li>常用的复杂度级别<ul>
<li>多项式阶：随着数据规模的增长，算法的执行时间和空间占用，按照多项式的比例增长，包括，O(1)(常数阶)、O(logn)(对数阶)、O(n)(线性阶)、O(nlogn)(线性对数阶)、O(n2)(平方阶)、O(n3)(立方阶)。</li>
<li>非多项式阶：随着数据规模的增长，算法的执行时间和空间占用暴增，这列算法性能极差。包括，O(2^n)(指数阶)、O(n!)(阶乘阶)</li>
</ul>
</li>
</ul>
<h3 id="（六）"><a href="#（六）" class="headerlink" title="（六）"></a>（六）</h3><ul>
<li>稳定性</li>
<li>假定在待排序的记录序列中，存在多个具有相同的关键字的记录，若经过排序，这些记录的相对次序保持不变，即在原序列中，A1&#x3D;A2，且A1在A2之前，而在排序后的序列中，A1仍在A2之前，则称这种排序算法是稳定的；否则称为不稳定的。</li>
<li>稳定也可以理解为一切皆在掌握中,元素的位置处在你在控制中.而不稳定算法有时就有点碰运气,随机的成分.当两元素相等时它们的位置在排序后可能仍然相同.但也可能不同.是未可知的.</li>
<li>不稳定排序算法<ul>
<li>快选希堆（快速排序，选择排序，希尔排序，堆排序）</li>
</ul>
</li>
</ul>
<h3 id="（七）"><a href="#（七）" class="headerlink" title="（七）"></a>（七）</h3><ul>
<li>算法总结</li>
<li>所需辅助空间最多：归并排序；<br>所需辅助空间最少：堆排序；<br>平均速度最快：快速排序；<br>不稳定：快速排序，希尔排序，堆排序。</li>
</ul>
<h4 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h4><ul>
<li>1、冒泡排序是一种用时间换空间的排序方法，n小时好</li>
<li>2、最坏情况是把顺序的排列变成逆序，或者把逆序的数列变成顺序，最差时间复杂度O(N^2)只是表示其操作次数的数量级</li>
<li>3、最好的情况是数据本来就有序，复杂度为O(n)</li>
</ul>
<h4 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h4><ul>
<li>1、n大时好，快速排序比较占用内存，内存随n的增大而增大，但却是效率高不稳定的排序算法。</li>
<li>2、划分之后一边是一个，一边是n-1个，<br>这种极端情况的时间复杂度就是O(N^2)</li>
<li>3、最好的情况是每次都能均匀的划分序列，O(N*log2N)</li>
</ul>
<h4 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h4><ul>
<li>1、n大时好，归并比较占用内存，内存随n的增大而增大，但却是效率高且稳定的排序算法。</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/onepixel/articles/7674659.html">十大经典排序算法（动图演示）</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/guidao13/article/details/86430483">Go语言经典排序算法实现</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/42586566">[算法总结] 十大排序算法</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/116046849">排序算法的稳定性</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaochun126/p/5086037.html">各种排序算法时间复杂度</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42907443/article/details/118329160">常见排序算法分类（排序算法，是算法的基石，你掌握多少？）</a> !!!</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/23/20220223-li-jie-zhuang-tai-ji-yuan-li-ji-shi-jian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/02/23/20220223-li-jie-zhuang-tai-ji-yuan-li-ji-shi-jian/" itemprop="url">理解状态机原理及实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-02-23T13:42:47+08:00">
                2022-02-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li><p>有限状态机FSM</p>
</li>
<li><p>描述事物的有限状态机模型的元素由以下组成：</p>
<ol>
<li>状态(State)：事物的状态，包括初始状态和所有事件触发后的状态</li>
<li>事件(Event)：触发状态变化或者保持原状态的事件</li>
<li>行为或转换(Action&#x2F;Transition)：执行状态转换的过程</li>
<li>检测器(Guard)：检测某种状态要转换成另一种状态的条件是否满足</li>
</ol>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/37281543f506">https://www.jianshu.com/p/37281543f506</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/46347732">深入浅出理解有限状态机</a></p>
</li>
<li><p>状态机的要素</p>
</li>
<li><p>状态机可归纳为4个要素，即现态、条件、动作、次态。“现态”和“条件”是因，“动作”和“次态”是果。详解如下：<br>  1. 现态：是指当前所处的状态。<br>  2. 条件：又称为“事件”。当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移。<br>  3. 动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必需的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。<br>  4. 次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。</p>
</li>
</ul>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><ol>
<li><p>定义状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ProcessState</span> &#123;</span><br><span class="line"></span><br><span class="line">    INIT(<span class="number">0</span>, <span class="string">&quot;未开始&quot;</span>),</span><br><span class="line">    READY_ONE_SIDE(<span class="number">1</span>, <span class="string">&quot;一方准备完成&quot;</span>),</span><br><span class="line">    READY_ALL(<span class="number">2</span>, <span class="string">&quot;双方准备完成&quot;</span>),</span><br><span class="line">    CHAT(<span class="number">3</span>, <span class="string">&quot;发言完成&quot;</span>),</span><br><span class="line">    END(<span class="number">4</span>, <span class="string">&quot;结束&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> val;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    ProcessState(<span class="type">int</span> val, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getVal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ProcessEvent</span> &#123;</span><br><span class="line"></span><br><span class="line">    READY_ONE_SIDE(<span class="number">1</span>, <span class="string">&quot;一方准备&quot;</span>),</span><br><span class="line">		READY_ALL(<span class="number">2</span>, <span class="string">&quot;另一方准备&quot;</span>),</span><br><span class="line">		CHAT(<span class="number">3</span>, <span class="string">&quot;发言&quot;</span>),</span><br><span class="line">		FORBID_ALL(<span class="number">4</span>, <span class="string">&quot;全员禁言&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    ProcessEvent(Integer code, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义状态机</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessEventConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProcessEvent event;</span><br><span class="line">    <span class="keyword">private</span> ProcessState fromState;</span><br><span class="line">    <span class="keyword">private</span> ProcessState toState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">desc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fromState.getDesc() + <span class="string">&quot;_&quot;</span> + event.getDesc() + <span class="string">&quot;_&quot;</span> + toState.getDesc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">List&lt;ProcessEventConfig&gt; configList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">configList.add(<span class="keyword">new</span> <span class="title class_">ProcessEventConfig</span>(ProcessEvent.READY_ONE_SIDE, ProcessState.INIT, ProcessState.READY_ONE_SIDE));</span><br><span class="line">configList.add(<span class="keyword">new</span> <span class="title class_">ProcessEventConfig</span>(ProcessEvent.READY_ALL, ProcessState.READY_ONE_SIDE, ProcessState.READY_ALL));</span><br><span class="line">configList.add(<span class="keyword">new</span> <span class="title class_">ProcessEventConfig</span>(ProcessEvent.CHAT, ProcessState.READY_ALL, ProcessState.CHAT));</span><br><span class="line">configList.add(<span class="keyword">new</span> <span class="title class_">ProcessEventConfig</span>(ProcessEvent.FORBID_ALL, ProcessState.CHAT, ProcessState.END));</span><br><span class="line"></span><br><span class="line">Map&lt;ProcessEvent, ProcessEventConfig&gt; eventResultStateConfigMap = <span class="keyword">new</span> <span class="title class_">EnumMap</span>&lt;&gt;(ProcessEvent.class);</span><br><span class="line"></span><br><span class="line">configList.forEach(eventConfig -&gt; eventResultStateConfigMap.put(eventConfig.getEvent(), eventConfig));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>触发状态变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">fire</span><span class="params">(ProcessEvent event, Process process)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ProcessEventConfig</span> <span class="variable">config</span> <span class="operator">=</span> Optional.ofNullable(eventResultStateConfigMap.get(event)).orElseThrow(() -&gt; ExceptionCodeEnum.AGRS_INVALID.newException(<span class="string">&quot;不存在该事件&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (process.getStatus() != config.getFromState().getVal()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        process.setRemark(config.desc());</span><br><span class="line">        process.setStatus(config.getToState().getVal());</span><br><span class="line"></span><br><span class="line">				<span class="comment">//DB改变状态</span></span><br><span class="line">				<span class="comment">/*update table set status=$&#123;status&#125; WHERE id=&#123;id&#125; AND status=$&#123;beforeStatus&#125;*/</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">suc</span> <span class="operator">=</span> processManager.updateStatus(process, config.getFromState().getVal());</span><br><span class="line">        <span class="keyword">if</span> (suc) &#123;</span><br><span class="line">               <span class="comment">//变更成功，业务逻辑    </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> suc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/20/20220220-nba-xuan-xiu-chou-qian-ju-ti-shi-ru-he-cao-zuo-de/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/02/20/20220220-nba-xuan-xiu-chou-qian-ju-ti-shi-ru-he-cao-zuo-de/" itemprop="url">nba选秀抽签具体是如何操作的？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-02-20T20:26:21+08:00">
                2022-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/52895544">nba选秀抽签具体是如何操作的？</a></p>
<ul>
<li>14个乒乓球分别贴上1-14数字，随机滚出4个，加起来是1001可能，其中11、12、13、14这个组合不算，剩下1000种可能。</li>
</ul>
<p><img src="/2022/02/20/20220220-nba-xuan-xiu-chou-qian-ju-ti-shi-ru-he-cao-zuo-de/nba%E9%80%89%E7%A7%80%E6%8A%BD%E7%AD%BE.jpg"></p>
<ul>
<li>闲来无事，使用Go粗暴模拟了一下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;sort&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">https://www.zhihu.com/question/52895544</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	n := <span class="number">14</span></span><br><span class="line">	m := <span class="number">4</span></span><br><span class="line">	nn := <span class="number">1</span></span><br><span class="line">	mm := <span class="number">1</span></span><br><span class="line">	nm := <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= n; i++ &#123;</span><br><span class="line">		nn = nn * i</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= m; i++ &#123;</span><br><span class="line">		mm = mm * i</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= (n - m); i++ &#123;</span><br><span class="line">		nm = nm * i</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	all_result := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">1000</span>)</span><br><span class="line">	all_result_map := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	count := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">11</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">for</span> j := i + <span class="number">1</span>; j &lt;= <span class="number">12</span>; j++ &#123;</span><br><span class="line">			<span class="keyword">for</span> k := j + <span class="number">1</span>; k &lt;= <span class="number">13</span>; k++ &#123;</span><br><span class="line">				<span class="keyword">for</span> l := k + <span class="number">1</span>; l &lt;= <span class="number">14</span>; l++ &#123;</span><br><span class="line">					<span class="comment">//fmt.Printf(&quot;%d -&gt; %d -&gt; %d -&gt; %d\n&quot;, i, j, k, l)</span></span><br><span class="line">					<span class="keyword">if</span> i == <span class="number">11</span> &amp;&amp; j == <span class="number">12</span> &amp;&amp; k == <span class="number">13</span> &amp;&amp; l == <span class="number">14</span> &#123;</span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">					all_result[count] = fmt.Sprintf(<span class="string">&quot;%d-%d-%d-%d&quot;</span>, i, j, k, l)</span><br><span class="line">					count++</span><br><span class="line">					all_result_map[fmt.Sprintf(<span class="string">&quot;%d-%d-%d-%d&quot;</span>, i, j, k, l)] = count</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	weight_arr := [<span class="number">14</span>]<span class="type">int</span>&#123;<span class="number">250</span>, <span class="number">199</span>, <span class="number">156</span>, <span class="number">119</span>, <span class="number">88</span>, <span class="number">63</span>, <span class="number">43</span>, <span class="number">28</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>&#125;</span><br><span class="line">	all_weight := <span class="number">0</span></span><br><span class="line">	source_map := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num, weight := <span class="keyword">range</span> weight_arr &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; weight; i++ &#123;</span><br><span class="line">			source_map[i+<span class="number">1</span>+all_weight] = num + <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">		all_weight = all_weight + weight</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	模拟前三顺位</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	all_hit_result := []<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">	all_hit_result_second_round := []<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">	all_hit_result_third_round := []<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">	r := rand.New(rand.NewSource(time.Now().Unix()))</span><br><span class="line">	<span class="keyword">for</span> xx := <span class="number">0</span>; xx &lt; <span class="number">1000000</span>; xx++ &#123;</span><br><span class="line"></span><br><span class="line">		hit_map := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>)</span><br><span class="line">		<span class="keyword">for</span> round := <span class="number">0</span>; round &lt; <span class="number">3</span>; round++ &#123;</span><br><span class="line">			all_ball := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>&#125;</span><br><span class="line"></span><br><span class="line">			chosen_ball := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">4</span>)</span><br><span class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line"></span><br><span class="line">				hit := r.Intn(<span class="number">14</span> - i)</span><br><span class="line">				chosen_ball[i] = all_ball[hit]</span><br><span class="line">				index := hit</span><br><span class="line">				all_ball = <span class="built_in">append</span>(all_ball[:index], all_ball[index+<span class="number">1</span>:]...)</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			sort.Ints(chosen_ball)</span><br><span class="line">			result := fmt.Sprintf(<span class="string">&quot;%d-%d-%d-%d&quot;</span>, chosen_ball[<span class="number">0</span>], chosen_ball[<span class="number">1</span>], chosen_ball[<span class="number">2</span>], chosen_ball[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> result == <span class="string">&quot;11-12-13-14&quot;</span> &#123;</span><br><span class="line">				round--</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			result_rank := source_map[all_result_map[result]]</span><br><span class="line"></span><br><span class="line">			value := hit_map[result_rank]</span><br><span class="line">			<span class="keyword">if</span> value == <span class="number">1</span> &#123;</span><br><span class="line">				round--</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> round == <span class="number">0</span> &#123;</span><br><span class="line">				all_hit_result[result_rank<span class="number">-1</span>]++</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> round == <span class="number">1</span> &#123;</span><br><span class="line">				all_hit_result_second_round[result_rank<span class="number">-1</span>]++</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> round == <span class="number">2</span> &#123;</span><br><span class="line">				all_hit_result_third_round[result_rank<span class="number">-1</span>]++</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			hit_map[result_rank] = <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;第一轮&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> i, resut_hit := <span class="keyword">range</span> all_hit_result &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%d -&gt; %d\n&quot;</span>, i+<span class="number">1</span>, resut_hit)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;第二轮&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> i, resut_hit := <span class="keyword">range</span> all_hit_result_second_round &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%d -&gt; %d\n&quot;</span>, i+<span class="number">1</span>, resut_hit)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;第三轮&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> i, resut_hit := <span class="keyword">range</span> all_hit_result_third_round &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%d -&gt; %d\n&quot;</span>, i+<span class="number">1</span>, resut_hit)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		模拟100万次</span></span><br><span class="line"><span class="comment">		第一轮</span></span><br><span class="line"><span class="comment">	1 -&gt; 249512</span></span><br><span class="line"><span class="comment">	2 -&gt; 198836</span></span><br><span class="line"><span class="comment">	3 -&gt; 155714</span></span><br><span class="line"><span class="comment">	4 -&gt; 118849</span></span><br><span class="line"><span class="comment">	5 -&gt; 88395</span></span><br><span class="line"><span class="comment">	6 -&gt; 63352</span></span><br><span class="line"><span class="comment">	7 -&gt; 43285</span></span><br><span class="line"><span class="comment">	8 -&gt; 28016</span></span><br><span class="line"><span class="comment">	9 -&gt; 16892</span></span><br><span class="line"><span class="comment">	10 -&gt; 11093</span></span><br><span class="line"><span class="comment">	11 -&gt; 7894</span></span><br><span class="line"><span class="comment">	12 -&gt; 7004</span></span><br><span class="line"><span class="comment">	13 -&gt; 6100</span></span><br><span class="line"><span class="comment">	14 -&gt; 5058</span></span><br><span class="line"><span class="comment">	第二轮</span></span><br><span class="line"><span class="comment">	1 -&gt; 215647</span></span><br><span class="line"><span class="comment">	2 -&gt; 188267</span></span><br><span class="line"><span class="comment">	3 -&gt; 157704</span></span><br><span class="line"><span class="comment">	4 -&gt; 125474</span></span><br><span class="line"><span class="comment">	5 -&gt; 96543</span></span><br><span class="line"><span class="comment">	6 -&gt; 71033</span></span><br><span class="line"><span class="comment">	7 -&gt; 49195</span></span><br><span class="line"><span class="comment">	8 -&gt; 32360</span></span><br><span class="line"><span class="comment">	9 -&gt; 19803</span></span><br><span class="line"><span class="comment">	10 -&gt; 13185</span></span><br><span class="line"><span class="comment">	11 -&gt; 9521</span></span><br><span class="line"><span class="comment">	12 -&gt; 8252</span></span><br><span class="line"><span class="comment">	13 -&gt; 7031</span></span><br><span class="line"><span class="comment">	14 -&gt; 5985</span></span><br><span class="line"><span class="comment">	第三轮</span></span><br><span class="line"><span class="comment">	1 -&gt; 177455</span></span><br><span class="line"><span class="comment">	2 -&gt; 171603</span></span><br><span class="line"><span class="comment">	3 -&gt; 155736</span></span><br><span class="line"><span class="comment">	4 -&gt; 133323</span></span><br><span class="line"><span class="comment">	5 -&gt; 106458</span></span><br><span class="line"><span class="comment">	6 -&gt; 81193</span></span><br><span class="line"><span class="comment">	7 -&gt; 58185</span></span><br><span class="line"><span class="comment">	8 -&gt; 38863</span></span><br><span class="line"><span class="comment">	9 -&gt; 24146</span></span><br><span class="line"><span class="comment">	10 -&gt; 15550</span></span><br><span class="line"><span class="comment">	11 -&gt; 11508</span></span><br><span class="line"><span class="comment">	12 -&gt; 10064</span></span><br><span class="line"><span class="comment">	13 -&gt; 8634</span></span><br><span class="line"><span class="comment">	14 -&gt; 7282</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/08/20220208-java11-ji-chu-yuan-li-he-shi-jian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/02/08/20220208-java11-ji-chu-yuan-li-he-shi-jian/" itemprop="url">Java11基础原理和实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-02-08T00:08:24+08:00">
                2022-02-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、为什么选择java11"><a href="#一、为什么选择java11" class="headerlink" title="一、为什么选择java11"></a>一、为什么选择java11</h1><p>Java 11 是 Java 8 之后的首个 LTS 版本（Long-term support 长期支持版本），所以有不少开发者表示会选择升级至 Java 11。</p>
<p><img src="/2022/02/08/20220208-java11-ji-chu-yuan-li-he-shi-jian/java11.png"></p>
<p>1、目前相对来说，Java 8 太旧，Java 17 太新，Java11 刚刚好；<br>2、支持以类路径方式运行，适合过渡阶段升级；<br>3、其他原因（下文会说明）</p>
<h1 id="二、模块系统"><a href="#二、模块系统" class="headerlink" title="二、模块系统"></a>二、模块系统</h1><p>模块系统是Java 9的旗舰功能，使用java9，有必要了解一下。</p>
<h2 id="java9之前存在哪些痛点"><a href="#java9之前存在哪些痛点" class="headerlink" title="java9之前存在哪些痛点"></a>java9之前存在哪些痛点</h2><h3 id="1、没有封装"><a href="#1、没有封装" class="headerlink" title="1、没有封装"></a>1、没有封装</h3><p>类一旦公开，意味着没有封装。</p>
<p>如果将一个类设置为protected，那么就可以防止其他类访问该类，除非这些类与该类位于相同的包中。但这样做会产生一个有趣的问题：如果想从组件的另一个包中访问该类，同时仍然防止其他类使用该类，那么应该怎么做呢？事实是无法做到。</p>
<p>让类公开，意味着对系统中的所有类型都是公开的，也就意味着没有封装。</p>
<p>Java在过去经历过相当多的安全漏洞。这些漏洞都有一个共同的特点：不知何故，攻击者可以绕过JVM的安全沙盒并访问JDK中的敏感类。从安全的角度来看，在JDK中对危险的内部类进行强封装是一个很大的改进。同时，减少运行时中可用类的数量会降低攻击面。在应用程序运行时中保留大量暂时不使用的类是一种不恰当的做法。而通过使用模块化JDK，可以确定应用程序所需的模块。</p>
<h3 id="2、编译时无法感知依赖缺失或类重复"><a href="#2、编译时无法感知依赖缺失或类重复" class="headerlink" title="2、编译时无法感知依赖缺失或类重复"></a>2、编译时无法感知依赖缺失或类重复</h3><p>Java确实使用了显式的import语句。但不幸的是，从严格意义上讲，这些导入是编译时结构，一旦将代码打包到JAR中，就无法确定哪些JAR包含当前JAR运行所需的类型。</p>
<p>在Java 9出现之前，JAR文件似乎是最接近模块的，它们拥有名称、对相关代码进行了分组并且提供了定义良好的公共接口。</p>
<p>（1）依赖缺失<br>所有类按照-classpath参数定义的顺序加载类。由于类会延迟加载，JVM无法在应用程序启动时有效地验证类路径的完整性，即无法预先知道类路径是否是完整的，或者是否应该添加另一个JAR。</p>
<p>（2）类重复<br>当类路径上有重复类时，则会出现更为隐蔽的问题。出现相同库的两个版本（如Guava 19和Guava 18）是非常常见的，这两个库JAR以一种未定义的顺序压缩到类路径中。库类的任一版本都可能会被首先加载。此外，有些类还可能会使用来自（可能不兼容的）其他版本的类。此时就会导致运行时异常。</p>
<h2 id="关于类重复"><a href="#关于类重复" class="headerlink" title="关于类重复"></a>关于类重复</h2><p>目前存在以下方法缓解或解决</p>
<h3 id="1、通过插件检查类重复"><a href="#1、通过插件检查类重复" class="headerlink" title="1、通过插件检查类重复"></a>1、通过插件检查类重复</h3><p>在编译时，检测类是否重复，比如使用插件 maven enforcer plugin，但本质上是通过解压全部jar包，检查所有文件是否存在重复类来判断的，效率可想而知。</p>
<h3 id="2、通过构建工具保证只存在一个版本的jar包"><a href="#2、通过构建工具保证只存在一个版本的jar包" class="headerlink" title="2、通过构建工具保证只存在一个版本的jar包"></a>2、通过构建工具保证只存在一个版本的jar包</h3><p>构建工具冲突失败策略设置如gradle中</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">configurations</span>.all &#123;</span><br><span class="line">    resolutionStrategy &#123;  failOnVersionConflict() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种设置仅仅是针对jar包冲突，不能保证不同名的jar包是否存在相同的类。</p>
<p>处理jar包冲突有两种策略：</p>
<p>1）强制指定版本：版本冲突太多，指定版本的情况，后续有新的版本间接依赖也无法直接发现。<br>2）取最高版本：同样有可能引起高版本导致不兼容的问题。</p>
<p>要彻底解决，只有项目依赖完全模块化。</p>
<h2 id="构建工具"><a href="#构建工具" class="headerlink" title="构建工具"></a>构建工具</h2><p>Maven、Gradle等构建工具，在运行时没有任何作用。Maven构建了想要运行的工件，但是最后仍然需要配置Java运行时，以便运行正确的模块路径和类路径。虽然手动配置模块路径比类路径要容易得多，但它仍然是重复的工作，因为相关信息已经在pom.xml文件中了。</p>
<h2 id="模块化的好处"><a href="#模块化的好处" class="headerlink" title="模块化的好处"></a>模块化的好处</h2><p>模块化 可以 在编译时和运行时获得所有这些信息所带来的优势。这可以防止对来自其他非引用模块的代码的意外依赖。通过检查（传递）依赖关系，工具链可以知道运行模块需要哪些附加模块并进行优化。</p>
<p>Java平台模块系统带来了如下最重要的好处：</p>
<p>1．可靠的配置在编译或运行代码之前，模块系统会检查给定的模块组合是否满足所有依赖关系，从而导致更少的运行时错误。<br>2．强封装型模块显式地选择了向其他模块公开的内容，从而防止对内部实现细节的意外依赖。<br>3．可扩展开发显式边界能够让开发团队并行工作，同时可创建可维护的代码库。只有显式导出的公共类型是共享的，这创建了由模块系统自动执行的边界。<br>4．安全性在JVM的最深层次上执行强封装，从而减少Java运行时的攻击面，同时无法获得对敏感内部类的反射访问。<br>5．优化由于模块系统知道哪些模块是在一起的，包括平台模块，因此在JVM启动期间不需要考虑其他代码。同时，其也为创建模块分发的最小配置提供了可能性。此外，还可以在一组模块上应用整个程序的优化。</p>
<p>在模块出现之前，这样做是非常困难的，因为没有可用的显式依赖信息，一个类可以引用类路径中任何其他类。</p>
<p>此外还有：<br>（1）JDK9的模块化可以减少Java程序打包的体积，同时拥有更好的隔离线与封装性。<br>在JDK9之前，JVM的基础类以前都是在rt.jar这个包里，这个包也是JRE运行的基石。这不仅是违反了单一职责原则，同样程序在编译的时候会将很多无用的类也一并打包，造成臃肿。在JDK9中，整个JDK都基于模块化进行构建，以前的rt.jar, tool.jar被拆分成数十个模块，编译的时候只编译实际用到的模块，同时各个类加载器各司其职，只加载自己负责的模块。<br>（2）经过破坏后的双亲委派模型更加高效，减少了很多类加载器之间不必要的委派操作</p>
<h2 id="模块系统的基础"><a href="#模块系统的基础" class="headerlink" title="模块系统的基础"></a>模块系统的基础</h2><p>本质上就是一个jar包切成多模块（更细的jar包）来引用</p>
<h3 id="1、module-info-java描述文件-关键字说明"><a href="#1、module-info-java描述文件-关键字说明" class="headerlink" title="1、module-info.java描述文件 关键字说明"></a>1、module-info.java描述文件 关键字说明</h3><p>requires代表依赖的模块，只有依赖的模块存在才能通过编译并运行.需要注意的是，所有模块均自动隐式依赖java.base模块，不需要显示声明<br>exports指出需要暴露的包，如果某个包没有被exports，那么其他模块是无法访问的。</p>
<p>Readability:指的是必须exports的包才可被其他模块访问<br>Accessibility:指的是即使是exports的包，其中的类的可访问下也要基于java的访问修饰符，仅有public修饰的才可被其他模块访问</p>
<p>Implied Readability(隐式Readability, requires transitive):<br>Readability默认情况下是不会被传递的<br>requires transitive，传递性依赖生效</p>
<p>由于requires transitive的存在，就可以支持聚合模块。有些聚合模块可以没有任何代码，就一个module-info.java描述文件，比如java.se, java.se.ee模块<br>不建议直接引用java.se模块，因为它就相当于java9以前版本的rt.jar的内容。</p>
<p>Qualified Exports(有限制的exports)<br>比如我只想exports某个包给部分模块,而不是所有模块</p>
<h3 id="2、模块化基础"><a href="#2、模块化基础" class="headerlink" title="2、模块化基础"></a>2、模块化基础</h3><p>（1）模块拥有一个名称，并对相关的代码以及可能的其他资源进行分组，同时使用一个模块描述符进行描述。模块描述符保存在一个名为module-info.java的文件中。<br>（2）模块描述符还可以包含exports语句。强封装性是模块的默认特性。只有当显式地导出一个包时（比如示例中的java.util.prefs），才可以从其他模块中访问该包<br>可访问性和可读性的结合可以确保在模块系统中实现强封装性。<br>（3）其他模块无法使用未导出包中的任何类型——即使包中的类型是公共的。这是对Java语言可访问性规则的根本变化。<br>（4）Java 9出现之后，public意味着仅对模块中的其他包公开。只有当导出包包含了公开类型时，其他模块才可以使用这些类型。这就是强封装的意义所在。</p>
<p>在模块出现之前，强封装实现类的唯一方法是将这些类放置到单个包中，并标记为私有。这种做法使得包变得非常笨重，实际上，将类公开只是为了实现不同包之间的访问。通过使用模块，可以以任何方式构建包，并仅导出模块使用者真正必须访问的包。如果愿意的话，还可以将导出的包构成模块的API。</p>
<p>（5）模块提供了导出包的显式信息，从而能够高效地对模块路径进行索引。当从给定的包中查找类型时，Java运行时和编译器可以准确地知道从模块路径中解析哪个模块。而在以前，对整个类路径进行扫描是找到任意类型的唯一方法。</p>
<p>在解析过程中还会完成一些额外的检查。例如，具有相同名称的两个模块在启动时（而不是在运行过程出现类加载失败时）会产生错误。此外，还会检查导出包的唯一性。</p>
<p>模块解析过程以及额外的检查确保了应用程序在一个可靠的环境中运行，降低了运行时失败的可能性。</p>
<p>（6）通过使用未命名模块，尚未模块化的代码可以继续在JDK 9上运行。<br>当将代码放在类路径上时，会自动使用未命名模块。这也意味着需要构建一个正确的类路径。可一旦使用了未命名模块，前面讨论的模块系统所带来的保障和好处也就没有了。</p>
<p>当在Java 9中使用类路径时，还需要注意两件事情。首先，由于平台是模块化的，因此对内部实现类进行了强封装。</p>
<p>（7）模块系统执行的另一个检查是循环依赖。<br>在编译时，模块之间的可读性关系必须是非循环的。而在模块中，仍然可以在类之间创建循环关系</p>
<p>（8）通过使用ServiceLoader API可在模块描述符和代码中表示服务<br>使用这个功能可以对代码的实现进行良好的封装</p>
<h3 id="3、以非模块化方式开发和运行应用"><a href="#3、以非模块化方式开发和运行应用" class="headerlink" title="3、以非模块化方式开发和运行应用"></a>3、以非模块化方式开发和运行应用</h3><p>在java9中也是允许你以非模块化方式开发和运行应用的(也就是说，模块化开发是可选的)，如果你的应用中没有module-info.java，那么这就是一个unnamed module. java9对于unnamed module的处理方式就是所有的jdk模块均直接可用(模块图中是以java.se模块作为root模块的，也意味着单独处于java.se.ee下的一些包，比如JAXB API是无法访问到的)。</p>
<p>但是需要注意的是，在java8以及之前的版本中，我们可以访问jdk中的一些不推荐访问的内部类，比如com.sun.image.codec.jpeg,但在java9模块化之后被强封装了，所以在java9中无法使用这些内部类，也就是说无法通过编译，但是java9为了保持兼容性，允许之前引用这些内部类的已有的jar或已编译的类正确运行。换言之，就是java9不允许源码中引用这些类，无法通过编译，但是之前版本中引用这些类的已编译class文件是允许正常运行的。</p>
<h1 id="三、迁移"><a href="#三、迁移" class="headerlink" title="三、迁移"></a>三、迁移</h1><p>（1）为了便于将基于类路径的应用程序迁移到Java 9，在对平台模块中的类应用深度反射时，或者使用反射来访问非导出包中的类型时，JVM默认显示警告</p>
<p>（2）那些在JDK 8和更早的版本上运行没有任何问题的代码现在会在控制台上显示一个醒目的警告——即使是在生产环境中也是如此。这表明严重破坏了强封装。除了这个警告之外，应用程序仍然照常运行。如警告消息所示，在下一个Java版本中行为将发生变化。将来，即使是类路径上的代码，JDK也会强制执行平台模块的强封装。</p>
<p>（3）可以使用–add-opens标志授予对模块中特定包的类路径深度反射访问。同样，当类路径上的代码尝试访问非导出包中的类型时，可以使用–add-exports来强制导出包。</p>
<p>（4）为了使逐步迁移成为可能，可以混合使用类路径和模块路径。但这不是一种理想的情况，因为只能部分受益于Java模块系统的优点。但是，“小步”迁移是非常有帮助的。</p>
<h2 id="自动模块"><a href="#自动模块" class="headerlink" title="自动模块"></a>自动模块</h2><p>Java模块系统提供了一个有用的功能来处理非模块的代码：自动模块。只需将现有的JAR文件从类路径移动到模块路径，而不改变其内容，就可以创建一个自动模块。这样一来，JAR就转换为一个模块，同时模块系统动态生成模块描述符。相比之下，显式模块始终有一个用户自定义的模块描述符。</p>
<p>自动模块的行为不同于显式模块。自动模块具有以下特征：</p>
<p>（1）不包含module-info.class；<br>（2）它有一个在META-INF&#x2F;MANIFEST.MF中指定或者来自其文件名的模块名称。<br>（3）通过requires transitive请求所有其他已解析模块。<br>（4）导出所有包。<br>（5）读取路径（或者更准确地讲，读取前面所讨论的未命名模块）。<br>（6）它不能与其他模块拆分包。</p>
<p>自动模块并不是一个设计良好的模块。虽然请求所有的模块并导出所有的包听起来不像是正确的模块化，但至少是可用的。</p>
<p>自动模块中仍然没有明确的信息来告诉模块系统真正需要哪些模块，这意味着JVM在启动时不会警告自动模块的依赖项丢失。</p>
<p>作为开发人员，负责确保模块路径（或类路径）包含所有必需的依赖项。这与使用类路径没有太大区别。</p>
<p>模块图中的所有模块都需要通过自动模块传递。这实际上意味着，如果请求一个自动模块，那么就可以“免费”获得所有其他模块的隐式可读性。</p>
<p>当使用自动模块时，也会遇到拆分包。在大型应用程序中，由于依赖关系管理不善，通常会发现拆分包。拆分包始终是一个错误，因为它们在类路径上不能可靠地工作。</p>
<h2 id="未命名模块"><a href="#未命名模块" class="headerlink" title="未命名模块"></a>未命名模块</h2><p>模块路径上的非模块化JAR变成了自动模块。而类路径变成了未命名模块。</p>
<p>类路径上的所有代码都是未命名模块的一部分。</p>
<p>存在一个很大的限制：未命名模块本身只能通过自动模块读取（只有自动模块可以读取类路径）</p>
<p>当读取未命名模块时自动模块和显式模块之间的区别。显式模块只能读取其他显式模块和自动模块。而自动模块可读取所有模块，包括未命名模块。</p>
<p>未命名模块的可读性只是一种在混合类路径&#x2F;模块路径迁移方案中有助于自动模块的机制。</p>
<p>JVM为什么没有那么“聪明”呢？它有权访问自动模块中的所有代码，那么为什么不分析依赖关系呢？如果想要分析这些代码是否调用其他模块，JVM需要对所有代码执行字节码分析。虽然这不难实现，但却是一个昂贵的操作，可能会大量增加大型应用程序的启动时间。而且，这样的分析不会发现通过反射产生的依赖关系。由于存在这些限制，JVM不可能也永远不会这样做。相反，JDK附带了另一个工具jdeps，它可以执行字节码分析。</p>
<p>现代构建工具通常有一个“在重复依赖项上失败”的设置，这使得依赖关系管理问题变得更加清晰，从而迫使尽早解决这些问题。强烈建议使用这个设置。关于该问题，Java模块系统比类路径要严格得多。当它检测到一个包从模块路径上的两个模块导出时，就会拒绝启动。相比于以前使用类路径时所遇到的不可靠情况，这种快速失败（fail-fast）机制要好得多。在开发过程中失败好过在生产过程中失败，尤其是当一些不幸的用户碰到一个由于模糊的类路径问题而被破坏的代码路径时。但这也意味着我们必须处理这些问题。盲目地将所有JAR从类路径移至模块路径可能导致在生成的自动模块之间出现拆分包。而这些拆分包将被模块系统所拒绝。</p>
<p>为了使迁移变得容易一些，当涉及自动模块和未命名模块时，上述规则存在一个例外，即承认很多类路径是不正确的，并且包含拆分包。当（自动）模块和未命名模块都包含相同的包时，将使用来自（自动）模块的包，而未命名模块中的包被忽略。</p>
<p>如果在迁移到Java 9时遇到了拆分包问题，那么是无法绕过的。即使从用户角度来看基于类路径的应用程序可以正确工作，你也必须处理这些问题。</p>
<p>拆分包会导致无法以模块系统的方式启动服务</p>
<h2 id="未命名模块（unnamed-module）和自动模块（automatic-module）总结"><a href="#未命名模块（unnamed-module）和自动模块（automatic-module）总结" class="headerlink" title="未命名模块（unnamed module）和自动模块（automatic module）总结"></a>未命名模块（unnamed module）和自动模块（automatic module）总结</h2><p>（1）一个未经模块化改造的 jar 文件是转为未命名模块还是自动模块，取决于这个 jar 文件出现的路径，如果是类路径，那么就会转为未命名模块，如果是模块路径，那么就会转为自动模块。注意，自动模块也属于命名模块的范畴，其名称是模块系统基于 jar 文件名自动推导得出的<br>（2）两者还有一个关键区别，分裂包规则适用于自动模块，但对未命名模块无效，也即多个未命名模块可以导出同一个包，但自动模块不允许。<br>（3） 未命名模块和自动模块存在的意义在于，无论传入的 jar 文件是否一个合法的模块（包含 module descriptor），Java 内部都可以统一的以模块的方式进行处理，这也是 Java 9 兼容老版本应用的架构原理。运行老版本应用时，所有 jar 文件都出现在类路径下，也就是转为未命名模块，对于未命名模块而言，默认导出所有包并且依赖所有模块，因此应用可以正常运行。<br>（4）基于未命名模块和自动模块，相应的就产生了两种老版本应用的迁移策略，或者说模块化策略。<br>（5）等所有 jar 包都完成模块化改造，应用改为 -m 方式启动，这也标志着应用已经迁移为真正的 Java 9 应用<br>（6）-cp 和 -m 可以同时存在 并运行？？可以（类路径和模块系统可以混合运行）</p>
<h2 id="java9-自动模块-的意义"><a href="#java9-自动模块-的意义" class="headerlink" title="java9 自动模块 的意义"></a>java9 自动模块 的意义</h2><p>（1）个人理解，只是为了让开发者能像模块一样使用起来，引入。实际上封装性方面和类路径没任何区别。<br>（2）未命名模块和自动模块存在的意义在于，无论传入的 jar 文件是否一个合法的模块（包含 module descriptor），Java 内部都可以统一的以模块的方式进行处理，这也是 Java 9 兼容老版本应用的架构原理。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>（1）如何用最快的速度判别它是不是一个模块？它又是如何定义的？<br>试试看 jar -d -f <jar_file>。<br>（2）通过JDK11内置jdeps工具查找过期以及废弃API以及对应的替换<br><code>./jdk-11.0.10.jdk/Contents/Home/bin/jdeps --jdk-internals ./build/libs/service.jar</code><br><code>./jdk-11.0.10.jdk/Contents/Home/bin/jdeps --jdk-internals -R --class-path ./build/deploy/* ./build/libs/*</code><br><code>jdeps --jdk-internals -R --class-path &#39;libs/*&#39; $project</code><br>libs是你的所有依赖的目录，$project是你的项目jar包<br>（3）我们可以在线上使用OpenJDK，开发时，使用任意的JDK。<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87157172">https://zhuanlan.zhihu.com/p/87157172</a></jar_file></p>
<h2 id="库迁移"><a href="#库迁移" class="headerlink" title="库迁移"></a>库迁移</h2><p>迁移库和迁移应用程序之间最大的区别在于库被许多应用程序使用。这些应用程序可能运行在不同版本的Java上，所以库通常需要在各种Java版本上工作。期望库的用户在你迁移库的同时切换到Java 9是不现实的。</p>
<p>库的迁移过程由以下步骤组成：</p>
<p>1）确保库可以作为自动模块在Java 9上运行。<br>2）使用Java 9编译器编译库（主要使用满足需求的最低Java版本），而不使用新的Java 9功能。<br>3）添加一个模块描述符，并将库转换为显式模块。<br>4）重构库的结构，以便增加封装性，识别API，并尽可能分割成多个模块（可选）。<br>5）开始使用库中的Java 9功能，同时保持向后兼容Java 9的早期版本。</p>
<p>库管理需要使用java8编译，模块描述需要用java9编译，且不能使用新特性，否则java8编译不过</p>
<p>项目模块化后，很多第三库（基于反射的），深度反射项目代码，或jdk，可能不能用，要进行特殊处理</p>
<p>历史解决jar包冲突问题得改造成模块化</p>
<h1 id="四、模块系统实践例子"><a href="#四、模块系统实践例子" class="headerlink" title="四、模块系统实践例子"></a>四、模块系统实践例子</h1><h2 id="1、相同模块不同版本，新版废弃方法"><a href="#1、相同模块不同版本，新版废弃方法" class="headerlink" title="1、相同模块不同版本，新版废弃方法"></a>1、相同模块不同版本，新版废弃方法</h2><p>结论：运行时才会报错</p>
<p>module_2-1.0  依赖 module_1-1.0 printInfo.print2()方法，项目依赖 module_1-2.0 printInfo.print3()；<br>build的时候并不能识别到错误，只有运行时才会发现错误 java.lang.NoSuchMethodError: com.kxw.module1.info.PrintInfo.print2()V</p>
<h2 id="2、不同模块含重复类"><a href="#2、不同模块含重复类" class="headerlink" title="2、不同模块含重复类"></a>2、不同模块含重复类</h2><p>结论：不同模块可以存在相同类，在引入时指定模块，可以正确加载到对应类</p>
<p>（1）如果同时引入两个不同模块（不管是直接还是间接），编译时会检测引入的模块是否包含可读的相同路径<br>编译报错：错误: 未命名的模块同时从 com.kxw.module.four 和 com.kxw.module.three 读取程序包 com.kxw.module.config</p>
<p>（2）如果模块存在相同类，但是却没有通过export声明，仅内部使用，那么编译时将无法检测，但运行时报 （两个模块都没有export的情况，结果一样）<br>Error occurred during initialization of boot layer<br>java.lang.LayerInstantiationException: Package com.kxw.module.config in both module com.kxw.module.three and</p>
<p>没声明（export）的情况下，运行时怎么检测有相同的package？<br>报：Checks for split packages between modules defined to the built-in class loaders.<br> ModuleBootstrap#checkSplitPackages 会检查所有module的package是否重复，通过String other &#x3D; packageToModule.putIfAbsent(p, name);来实现</p>
<p>结论：只要是一个模块，且被引入，有相同包名都可以在启动时被检测出来并报错 （为什么编译时不做的呢？main方法不明确？还是要指定主模块？）</p>
<p>注意：类路径加载的模块都是未命名模块，且不会因为包冲突而报错 </p>
<h1 id="五、classloader的变化"><a href="#五、classloader的变化" class="headerlink" title="五、classloader的变化"></a>五、classloader的变化</h1><h2 id="1、类加载器变化概览"><a href="#1、类加载器变化概览" class="headerlink" title="1、类加载器变化概览"></a>1、类加载器变化概览</h2><h3 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h3><p>（1）任意一个 ClassLoader 在尝试加载一个类的时候，都会先尝试调用其父类的相关方法去加载类，如果其父类不能加载该类，则交由子类去完成。 这样的好处：对于任意使用者自定义的 ClassLoader，都会先去尝试让 jvm 的 Bootstrap ClassLoader 去尝试加载(自定义的 ClassLoader 都继承了它们)。那么就能保证 jvm 的类会被优先加载，限制了使用者对 jvm 系统的影响。</p>
<p>（2）jdk9中的双亲委派机制仍然存在，只是在委派之前会优先寻找模块所属的加载器进行加载。</p>
<h3 id="jdk9之前"><a href="#jdk9之前" class="headerlink" title="jdk9之前"></a>jdk9之前</h3><p>Boostrap -&gt; Extension -&gt; Application</p>
<p>（1）bootstrap classloader加载rt.jar，jre&#x2F;lib&#x2F;endorsed （用来加载 jvm 自身需要的类，c++ 实现，用来加载 rt.jar）<br>（2）ext classloader加载jre&#x2F;lib&#x2F;ext （ 在 jdk9 中已经被移除。）<br>（3）application classloader加载-cp指定的类 (负责加载ClassPath路径下的类)</p>
<h3 id="jdk9及之后"><a href="#jdk9及之后" class="headerlink" title="jdk9及之后"></a>jdk9及之后</h3><p>Application -&gt; Platform -&gt; Boostrap</p>
<p>（1）bootstrap classloader加载lib&#x2F;modules 中的核心模块 （主要用来加载 java.base 中的核心系统类）<br>（2）ext classloader被废弃，新增platform classloader，加载lib&#x2F;modules的非核心模块 （用来加载 jdk 中的非核心模块类）<br>（3）application classloader加载-cp，-mp指定的类 （用来加载一般的应用类）</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>JDK9开始，AppClassLoader父类不再是 URLClassLoader；而是BuiltinClassLoader</p>
<p>之前对于动态加载的类，我们总是通过将这个类通过反射调用URLClassLoader加到classpath里面进行加载。这么加载在JDK11中已经无法实现，并且这样加载的类不能卸载。 对于动态加载的类，我们在OpenJDK11中只能自定义类加载器去加载，而不是通过获取APPClassLoader去加载。同时，这么做也有助于你随时能将动态加载的类卸载，因为并没有加载到APPClassLoader。</p>
<p>建议使用自定义的类加载器继承SecureClassLoader去加载类：java.security.SecureClassLoader</p>
<h3 id="BuiltinClassLoader"><a href="#BuiltinClassLoader" class="headerlink" title="BuiltinClassLoader"></a>BuiltinClassLoader</h3><p>BuiltinClassLoader 是 jdk9 中代替 URLClassLoader 的加载器，是 PlatformClassLoader 与 AppClassLoader 的父类。其继承了 SecureClassLoader，其核心的方法主要是 loadClassOrNull(…) 方法</p>
<h3 id="如何自定义加载器"><a href="#如何自定义加载器" class="headerlink" title="如何自定义加载器"></a>如何自定义加载器</h3><p>（1）java9之前</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArthasClassloader</span> <span class="keyword">extends</span> <span class="title class_">URLClassLoader</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ArthasClassloader</span><span class="params">(URL[] urls)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>(urls, ClassLoader.getSystemClassLoader().getParent());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"><span class="keyword">final</span> Class&lt;?&gt; loadedClass = findLoadedClass(name);</span><br><span class="line"><span class="keyword">if</span> (loadedClass != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> loadedClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优先从parent（SystemClassLoader）里加载系统类，避免抛出ClassNotFoundException</span></span><br><span class="line"><span class="keyword">if</span> (name != <span class="literal">null</span> &amp;&amp; (name.startsWith(<span class="string">&quot;sun.&quot;</span>) || name.startsWith(<span class="string">&quot;java.&quot;</span>))) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Class&lt;?&gt; aClass = findClass(name);</span><br><span class="line"><span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">resolveClass(aClass);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> aClass;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">// ignore</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）java9之后</p>
<p>TODO</p>
<h2 id="2、扩展机制"><a href="#2、扩展机制" class="headerlink" title="2、扩展机制"></a>2、扩展机制</h2><p>（1）版本9之前的Java SE允许扩展机制，可以通过将JAR放置在系统属性java.ext.dirs指定的目录中来扩展运行时映像。 如果未设置此系统属性，则使用jre\lib\ext目录作为其默认值。 该机制通过扩展类加载器（这是引导类加载器的子类）和系统类加载器的父级加载了该目录中的所有JAR。 它加载所有应用程序类。 这些JAR的内容对于在此运行时映像上编译或运行的所有应用程序都可见。</p>
<p>（2）Java SE 9不支持扩展机制。 如果需要类似的功能，可以将这些JAR放在类路径的前面。 使用名为JAVA_HOME\lib\ext的目录或设置名为java.ext.dirs的系统属性会导致JDK 9中的错误。</p>
<p>（3）在JDK 9之前，扩展类加载器和应用程序类加载器是java.net.URLClassLoader类的一个实例。 在JDK 9中，平台类加载器（以前的扩展类加载器）和应用程序类加载器是内部JDK类的实例。 如果你的代码依赖于URLClassLoader类的特定方法，代码可能会在JDK 9中崩溃。</p>
<h2 id="3、类加载器的加载流程"><a href="#3、类加载器的加载流程" class="headerlink" title="3、类加载器的加载流程"></a>3、类加载器的加载流程</h2><p><img src="/2022/02/08/20220208-java11-ji-chu-yuan-li-he-shi-jian/java11_classloader.png"></p>
<h3 id="在JDK-9之前"><a href="#在JDK-9之前" class="headerlink" title="在JDK 9之前"></a>在JDK 9之前</h3><p>a. JDK使用三个类加载器来加载类<br>b. JDK类加载器以分层方式工作 —— 引导类加载器位于层次结构的顶部。 类加载器将类加载请求委托给上层类加载器。</p>
<p>例如，如果应用程序类加载器需要加载一个类，它将请求委托给扩展类加载器，扩展类加载器又将请求委托给引导类加载器。 如果引导类加载器无法加载类，扩展类加载器将尝试加载它。 如果扩展类加载器无法加载类，则应用程序类加载器尝试加载它。 如果应用程序类加载器无法加载它，则抛出ClassNotFoundException异常。</p>
<p>c. 引导类加载器是扩展类加载器的父类。 扩展类加载器是应用程序类加载器的父类。 引导类加载器没有父类。 默认情况下，应用程序类加载器将是你创建的其他类加载器的父类。</p>
<h3 id="在JDK-9之前的类加载机制"><a href="#在JDK-9之前的类加载机制" class="headerlink" title="在JDK 9之前的类加载机制"></a>在JDK 9之前的类加载机制</h3><p>（1）【Boostrap】引导类加载器加载由Java平台组成的引导类，包括JAVA_HOME\lib\rt.jar中的类和其他几个运行时JAR。 它完全在虚拟机中实现。 可以使用-Xbootclasspath&#x2F;p和-Xbootclasspath&#x2F;a命令行选项来附加引导目录。 可以使用-Xbootclasspath选项指定引导类路径，该选项将替换默认的引导类路径。 在运行时，sun.boot.class.path系统属性包含引导类路径的只读值。 JDK通过null表示这个类加载器。 也就是说，你不能得到它的引用。 例如，Object类由引导类加载器加载，并且Object.class.getClassLoader()表达式将返回null。</p>
<p>（2）【Extension】扩展类加载器用于通过java.ext.dirs系统属性指定的目录中的位于JAR中的扩展机制加载可用的类。要获得扩展类加载器的引用，需要获取应用程序类加载器的引用，并在该引用上使用getParent()方法。</p>
<p>（3）【Application】应用程序类加载器从由CLASSPATH环境变量指定的应用程序类路径或命令行选项-cp或-classpath加载类。应用程序类加载器也称为系统类加载器，这是一种误称，它暗示它加载系统类。可以使用ClassLoader类的静态方法getSystemClassLoader()获取对应用程序类加载器的引用。</p>
<h3 id="在JDK-9及之后"><a href="#在JDK-9及之后" class="headerlink" title="在JDK 9及之后"></a>在JDK 9及之后</h3><p>a. JDK9保持三级分层类加载器架构以实现向后兼容。但是，从模块系统加载类的方式有一些变化。<br>b. 在JDK 9中，应用程序类加载器【Application】可以委托给平台类加载器【Platform】以及引导类加载器【Boostrap】；平台类加载器【Platform】可以委托给引导类加载器【Boostrap】和应用程序类加载器【Application】。</p>
<p>（1）在JDK 9中，引导类加载器是由类库和代码在虚拟机中实现的(不再是c++实现)。 为了向后兼容，它在程序中仍然由null表示。 例如，Object.class.getClassLoader()仍然返回null。 但是，并不是所有的Java SE平台和JDK模块都由引导类加载器加载。 举几个例子，引导类加载器加载的模块是java.base，java.logging，java.prefs和java.desktop。 其他Java SE平台和JDK模块由平台类加载器和应用程序类加载器加载，这在下面介绍。 JDK 9中不再支持用于指定引导类路径，-Xbootclasspath和-Xbootclasspath&#x2F;p选项以及系统属性sun.boot.class.path。-Xbootclasspath&#x2F;a选项仍然受支持，其值存储在jdk.boot.class.path.append的系统属性中。</p>
<p>（2）JDK 9不再支持扩展机制。 但是，它将扩展类加载器保留在名为平台类加载器的新名称下。 ClassLoader类包含一个名为getPlatformClassLoader()的静态方法，该方法返回对平台类加载器的引用。 下表包含平台类加载器加载的模块列表。 平台类加载器用于另一目的。 默认情况下，由引导类加载器加载的类将被授予所有权限。 但是，几个类不需要所有权限。 这些类在JDK 9中已经被取消了特权，并且它们被平台类加载器加载以提高安全性。<br>下面是JDK 9中由平台加载器加载的模块列表。</p>
<p>（3）应用程序类加载器加载在模块路径上找到的应用程序模块和一些提供工具或导出工具API的JDK模块，如下表所示。 仍然可以使用ClassLoader类的getSystemClassLoader()的静态方法来获取应用程序类加载器的引用。</p>
<h3 id="在JDK-9及之后的的类加载机制"><a href="#在JDK-9及之后的的类加载机制" class="headerlink" title="在JDK 9及之后的的类加载机制"></a>在JDK 9及之后的的类加载机制</h3><p>三个内置的类加载器一起协作来加载类。</p>
<p>（1）当应用程序类加载器需要加载类时，它将搜索定义到所有类加载器的模块。 如果有合适的模块定义在这些类加载器中，则该类加载器将加载类，这意味着应用程序类加载器现在可以委托给引导类加载器和平台类加载器。 如果在为这些类加载器定义的命名模块中找不到类，则应用程序类加载器将委托给其父类，即平台类加载器。 如果类尚未加载，则应用程序类加载器将搜索类路径。 如果它在类路径中找到类，它将作为其未命名模块的成员加载该类。 如果在类路径中找不到类，则抛出ClassNotFoundException异常。</p>
<p>（2）当平台类加载器需要加载类时，它将搜索定义到所有类加载器的模块。 如果一个合适的模块被定义为这些类加载器中，则该类加载器加载该类。 这意味着平台类加载器可以委托给引导类加载器以及应用程序类加载器。 如果在为这些类加载器定义的命名模块中找不到一个类，那么平台类加载器将委托给它的父类，即引导类加载器。</p>
<p>（3）当引导类加载器需要加载一个类时，它会搜索自己的命名模块列表。 如果找不到类，它将通过命令行选项-Xbootclasspath&#x2F;a指定的文件和目录列表进行搜索。 如果它在引导类路径上找到一个类，它将作为其未命名模块的成员加载该类。</p>
<p>JDK 9包含一个名为-Xlog::modules的选项，用于在虚拟机加载时记录调试或跟踪消息，可以看到类加载器及其加载的模块和类。其格式如下：</p>
<p><code>-Xlog:modules=&lt;debug|trace&gt;</code><br><code>java -Xlog:modules=trace --module-path lib --module com.jdojo.prime.client/com.jdojo.prime.client.Main &gt; test.txt</code></p>
<h3 id="JDK-9各类加载器对应加载的模块"><a href="#JDK-9各类加载器对应加载的模块" class="headerlink" title="JDK 9各类加载器对应加载的模块"></a>JDK 9各类加载器对应加载的模块</h3><p>（1）bootstrap classloader加载lib&#x2F;modules</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.base java.security.sasl</span><br><span class="line">java.datatransfer java.xml</span><br><span class="line">java.desktop jdk.httpserver</span><br><span class="line">java.instrument jdk.internal.vm.ci</span><br><span class="line">java.logging jdk.management</span><br><span class="line">java.management jdk.management.agent</span><br><span class="line">java.management.rmi jdk.naming.rmi</span><br><span class="line">java.naming jdk.net</span><br><span class="line">java.prefs jdk.sctp</span><br><span class="line">java.rmi jdk.unsupported</span><br></pre></td></tr></table></figure>
<p>（2）platform classloader，加载lib&#x2F;modules</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">java.activation* jdk.accessibility</span><br><span class="line">java.compiler* jdk.charsets</span><br><span class="line">java.corba* jdk.crypto.cryptoki</span><br><span class="line">java.scripting jdk.crypto.ec</span><br><span class="line">java.se jdk.dynalink</span><br><span class="line">java.se.ee jdk.incubator.httpclient</span><br><span class="line">java.security.jgss jdk.internal.vm.compiler*</span><br><span class="line">java.smartcardio jdk.jsobject</span><br><span class="line">java.sql jdk.localedata</span><br><span class="line">java.sql.rowset jdk.naming.dns</span><br><span class="line">java.transaction* jdk.scripting.nashorn</span><br><span class="line">java.xml.bind* jdk.security.auth</span><br><span class="line">java.xml.crypto jdk.security.jgss</span><br><span class="line">java.xml.ws* jdk.xml.dom</span><br><span class="line">java.xml.ws.annotation* jdk.zipfs</span><br></pre></td></tr></table></figure>
<p>（3）application classloader加载-cp，-mp指定的类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jdk.aot jdk.jdeps</span><br><span class="line">jdk.attach jdk.jdi</span><br><span class="line">jdk.compiler jdk.jdwp.agent</span><br><span class="line">jdk.editpad jdk.jlink</span><br><span class="line">jdk.hotspot.agent jdk.jshell</span><br><span class="line">jdk.internal.ed jdk.jstatd</span><br><span class="line">jdk.internal.jvmstat jdk.pack</span><br><span class="line">jdk.internal.le jdk.policytool</span><br><span class="line">jdk.internal.opt jdk.rmic</span><br><span class="line">jdk.jartool jdk.scripting.nashorn.shell</span><br><span class="line">jdk.javadoc jdk.xml.bind*</span><br><span class="line">jdk.jcmd jdk.xml.ws*</span><br><span class="line">jdk.jconsole</span><br></pre></td></tr></table></figure>
<h2 id="4、其他"><a href="#4、其他" class="headerlink" title="4、其他"></a>4、其他</h2><p>（1）如果你想访问classpath下的内容，你可以读取环境变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">pathSeparator</span> <span class="operator">=</span> System</span><br><span class="line">.getProperty(<span class="string">&quot;path.separator&quot;</span>);</span><br><span class="line">String[] classPathEntries = System</span><br><span class="line">.getProperty(<span class="string">&quot;java.class.path&quot;</span>)</span><br><span class="line">.split(pathSeparator);</span><br></pre></td></tr></table></figure>
<p>（2）设置虚拟机参数为”-XX:+TraceClassLoading”来获取类加载信息<br>（3）如何判断类是有未命名模块加载，还是正常模块加载的 ：clazz.getModule()</p>
<h1 id="六、垃圾回收器"><a href="#六、垃圾回收器" class="headerlink" title="六、垃圾回收器"></a>六、垃圾回收器</h1><h2 id="JDK-11-默认使用G1"><a href="#JDK-11-默认使用G1" class="headerlink" title="JDK 11 默认使用G1"></a>JDK 11 默认使用G1</h2><p>G1会比CMS有更多的内存消耗，多了两个内存结构：</p>
<p>Remembered Sets：每个区块Region都有一个与之对应的Remembered Set来记录不同区块间对象引用（其他收集器只是记录新生代、老年代间互相引用）。用来避免全堆扫描<br>Collection Sets：将要被回收区块对象的集合，GC时收集器将这些区块对象复制到其他区块中</p>
<h2 id="ZGC"><a href="#ZGC" class="headerlink" title="ZGC"></a>ZGC</h2><p>ZGC（The Z Garbage Collector）是JDK 11中推出的一款低延迟垃圾回收器，它的设计目标包括：</p>
<p>停顿时间不超过10ms；<br>停顿时间不会随着堆的大小，或者活跃对象的大小而增加；<br>支持8MB~4TB级别的堆（未来支持16TB）。</p>
<p>从设计目标来看，我们知道ZGC适用于大内存低延迟服务的内存管理和回收。</p>
<p>对吞吐量优先的场景，ZGC可能并不适合。<br>ZGC作为下一代垃圾回收器，性能非常优秀。ZGC垃圾回收过程几乎全部是并发，实际STW停顿时间极短，不到10ms。这得益于其采用的着色指针和读屏障技术。</p>
<p>后续考虑在生产环境使用ZGC。</p>
<h1 id="七、新特性"><a href="#七、新特性" class="headerlink" title="七、新特性"></a>七、新特性</h1><h2 id="1、HttpClient-API"><a href="#1、HttpClient-API" class="headerlink" title="1、HttpClient API"></a>1、HttpClient API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newHttpClient();</span><br><span class="line"><span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">.uri(URI.create(<span class="string">&quot;http://openjdk.java.net/&quot;</span>))</span><br><span class="line">.build();</span><br><span class="line">client.sendAsync(request, BodyHandlers.ofString())</span><br><span class="line">.thenApply(HttpResponse::body)</span><br><span class="line">.thenAccept(System.out::println)</span><br><span class="line">.join();</span><br></pre></td></tr></table></figure>
<h2 id="2、使用Stream-dropWhile-简化代码"><a href="#2、使用Stream-dropWhile-简化代码" class="headerlink" title="2、使用Stream dropWhile 简化代码"></a>2、使用Stream dropWhile 简化代码</h2><p>获取列表从lastId开始到结尾的子集</p>
<p>java8</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (UserDynamicSortSetMemberWithScoreBO bo : sortSetKeyList) &#123;</span><br><span class="line"><span class="keyword">if</span> (bo.getId() == lastId) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">index++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sortSetKeyList.stream()</span><br><span class="line">.skip(index + <span class="number">1</span>)</span><br><span class="line">.limit(DynamicConfig.feedListPageSize())</span><br><span class="line">.collect(Collectors.toList());</span><br></pre></td></tr></table></figure>
<p>java9</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> sortSetKeyList.stream()</span><br><span class="line">.dropWhile(v -&gt; !v.getId().equals(lastId))</span><br><span class="line">.skip(<span class="number">1</span>)</span><br><span class="line">.limit(DynamicConfig.feedListPageSize())</span><br><span class="line">.collect(Collectors.toList());</span><br></pre></td></tr></table></figure>
<h2 id="3、Optional-ifPresentOrElse"><a href="#3、Optional-ifPresentOrElse" class="headerlink" title="3、Optional.ifPresentOrElse"></a>3、Optional.ifPresentOrElse</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">optional.ifPresentOrElse( x -&gt; System.out.println(<span class="string">&quot;Value: &quot;</span> + x),() -&gt;</span><br><span class="line">System.out.println(<span class="string">&quot;Not Present.&quot;</span>));</span><br></pre></td></tr></table></figure>


<h1 id="八、迁移实践"><a href="#八、迁移实践" class="headerlink" title="八、迁移实践"></a>八、迁移实践</h1><h2 id="目标1：可运行"><a href="#目标1：可运行" class="headerlink" title="目标1：可运行"></a>目标1：可运行</h2><p>由于项目历史沉重（代码不兼容或依赖未模块化），先使用旧方式运行（类路径而不是模块系统）</p>
<p>1、目标：用最简单快速的方式使用java11编译和运行代码<br>2、收益：使用属于Java 9-11 新的API、工具和性能改进。<br>3、未使用Java 9的旗舰功能——模块系统，仍使用类路径方式运行服务</p>
<h2 id="目标2：使用模块系统运行"><a href="#目标2：使用模块系统运行" class="headerlink" title="目标2：使用模块系统运行"></a>目标2：使用模块系统运行</h2><p>模块化改造，在现有的项目中如何发挥模块化的作用</p>
<h3 id="自动模块会exports所有包，导致分包问题，不同模块包含相同包"><a href="#自动模块会exports所有包，导致分包问题，不同模块包含相同包" class="headerlink" title="自动模块会exports所有包，导致分包问题，不同模块包含相同包"></a>自动模块会exports所有包，导致分包问题，不同模块包含相同包</h3><p>解决的方法：<br>（1）改代码，去除这种不规范（难，第三方包很多这种）<br>（2）把这种包放在未命名模块</p>
<h3 id="由于完全模块化分包的问题无法解决，所以要混合两种方式运行项目"><a href="#由于完全模块化分包的问题无法解决，所以要混合两种方式运行项目" class="headerlink" title="由于完全模块化分包的问题无法解决，所以要混合两种方式运行项目"></a>由于完全模块化分包的问题无法解决，所以要混合两种方式运行项目</h3><p>gradle对混合两种（类路径和模块系统）的支持不足<br>直接命令行使用混合两种运行是可以的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./jdk-11.0.10.jdk/Contents/Home/bin/java --add-opens=java.base/jdk.internal.loader=ALL-UNNAMED -cp &quot;build/deploy/*&quot; -p &quot;build/module/*&quot; --add-modules &quot;com.xx.xx.xx&quot; com.xx.xx.xx.Application</span><br></pre></td></tr></table></figure>


<h2 id="目标3：使用java17"><a href="#目标3：使用java17" class="headerlink" title="目标3：使用java17"></a>目标3：使用java17</h2><h3 id="1、Gradle-7-3-is-the-first-version-fully-supporting-Java-17"><a href="#1、Gradle-7-3-is-the-first-version-fully-supporting-Java-17" class="headerlink" title="1、Gradle 7.3 is the first version fully supporting Java 17"></a>1、Gradle 7.3 is the first version fully supporting Java 17</h3><h3 id="2、Spring-Boot-2-5-5是Spring-Boot-第一个支持Java-17的版本"><a href="#2、Spring-Boot-2-5-5是Spring-Boot-第一个支持Java-17的版本" class="headerlink" title="2、Spring Boot 2.5.5是Spring Boot 第一个支持Java 17的版本"></a>2、Spring Boot 2.5.5是Spring Boot 第一个支持Java 17的版本</h3><h1 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h1><ul>
<li>新版本jdk现在基本都是规定时间内免费，比如半年或三年，一般情况下直接用openjdk就足够了。</li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1598291">OpenJDK和Oracle JDK有什么区别和联系</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fokyl.com/news/openjdk%20oracle%20jdk%20.html">openjdk与Oraclejdk的区别</a><ul>
<li>在2006年11月13日的JavaOne大会上，Sun公司（当时还没被收购）宣布计划要把Java开源，在随后的一年多时间内，它陆续地将JDK的各个部分在GPL v2（GNU General Public License v2）协议下公开了源码，并建立了OpenJDK组织对这些源码进行独立管理。除了极少量的产权代码（Encumbered Code，这部分代码所有权不属于Sun公司，Sun本身也无权进行开源处理）外，OpenJDK几乎拥有了当时SunJDK 的全部代码。</li>
<li>但是随着JDK版本的不断发布，Oracle失去了维护OpenJDK的耐心，因为不赚钱啊。RedHat从Oracle手上接过OpenJDK的管理权利和维护职责。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/19646618">https://www.zhihu.com/question/19646618</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/353325963">https://www.zhihu.com/question/353325963</a><ul>
<li>OpenJDK 实际上不适合拿来和 OracleJDK 进行对比，OpenJDK 不提供 LTS 服务，而 OracleJDK 每三年都会推出一个 LTS 版进行长期支持。</li>
</ul>
</li>
<li>从 11+ 版本开始 -XX:+UseContainerSupport 已经自动开启, 可以自适应内存pod的内存限制,不用通过<code>-Xms -Xmx</code> 来设置</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li>[Java 9模块化开发_核心原则与实践]</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34378888/article/details/112584392">模块化加载_Java9模块化的类加载机制实现剖析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/eMac/article/details/107131444">【JDK 11】关于 Java 模块系统，看这一篇就够了</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/IcanFixIt/p/7131676.html">Java 9 揭秘（8. JDK 9重大改变）</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87157172">从JDK8升级到JDK11，看这篇就足够了</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47685388/load-class-from-exploded-module-using-custom-classloader">Load class from exploded module using custom classloader</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/java-classloaders">Class Loaders in Java</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/60764/how-to-load-jar-files-dynamically-at-runtime">How to load JAR files dynamically at Runtime?</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46112809/is-it-possible-to-load-and-unload-jdk-and-custom-modules-dynamically-in-java-9">Is it possible to load and unload jdk and custom modules dynamically in Java 9?</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903666932006926">聊聊java9的classloader</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020110723">JVM_类加载机制详解</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ag5u2EPObx7bZr7hkcrOTg">新一代垃圾回收器ZGC的探索与实践</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/01/17/20220117-nio-zong-jie-bi-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/01/17/20220117-nio-zong-jie-bi-ji/" itemprop="url">NIO总结笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-01-17T14:55:32+08:00">
                2022-01-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Java-I-x2F-O"><a href="#Java-I-x2F-O" class="headerlink" title="Java I&#x2F;O"></a>Java I&#x2F;O</h2><table>
<thead>
<tr>
<th>I&#x2F;O</th>
<th>NIO</th>
</tr>
</thead>
<tbody><tr>
<td>面向流</td>
<td>面向缓冲</td>
</tr>
<tr>
<td>阻塞IO</td>
<td>非阻塞IO</td>
</tr>
<tr>
<td>无</td>
<td>选择器</td>
</tr>
</tbody></table>
<ul>
<li>I&#x2F;O 与 NIO 一个比较重要的区别是我们使用 I&#x2F;O 的时候往往会引入多线程，每个连接使用一个单独的线程，而 NIO 则是使用单线程或者只使用少量的多线程，每个连接共用一个线程。而由于 NIO 的非阻塞需要一直轮询，比较消耗系统资源，所以异步非阻塞模式 AIO 就诞生了。</li>
</ul>
<h3 id="5-种-I-x2F-O模型"><a href="#5-种-I-x2F-O模型" class="headerlink" title="5 种 I&#x2F;O模型"></a>5 种 I&#x2F;O模型</h3><ol>
<li>blocking I&#x2F;O</li>
<li>nonblocking I&#x2F;O</li>
<li>I&#x2F;O multiplexing (select and poll)</li>
<li>signal driven I&#x2F;O (SIGIO)</li>
<li>asynchronous I&#x2F;O (the POSIX aio_functions)。</li>
</ol>
<ul>
<li>不同的操作系统对上述模型支持不同，UNIX 支持 IO 多路复用。不同系统叫法不同，freebsd 里面叫 kqueue，Linux 叫 epoll。而 Windows2000 的时候就诞生了 IOCP 用以支持 asynchronous I&#x2F;O。</li>
<li>Java 是一种跨平台语言，为了支持异步 I&#x2F;O，诞生了 NIO，Java1.4 引入的 NIO1.0 是基于 I&#x2F;O 复用的，它在各个平台上会选择不同的复用方式。Linux 用的 epoll，BSD 上用 kqueue，Windows 上是重叠 I&#x2F;O。</li>
<li>IO多路复用，Java NIO的核心类库多路复用器Selector就是基于epoll的多路复用技术实现。</li>
<li>IO复用的系统调用方式：select，pselect，poll，epoll（IO复用属于同步IO）</li>
<li>同步阻塞BIO，同步非阻塞NIO，异步非阻塞AIO<br> 同步IO和异步IO的区别就在于：数据拷贝的时候进程是否阻塞！<br>阻塞IO和非阻塞IO的区别就在于：应用程序的调用是否立即返回！</li>
</ul>
<h3 id="Java-I-x2F-O-的相关方法"><a href="#Java-I-x2F-O-的相关方法" class="headerlink" title="Java I&#x2F;O 的相关方法"></a>Java I&#x2F;O 的相关方法</h3><ol>
<li>同步并阻塞 (I&#x2F;O 方法)：服务器实现模式为一个连接启动一个线程，每个线程亲自处理 I&#x2F;O 并且一直等待 I&#x2F;O 直到完成，即客户端有连接请求时服务器端就需要启动一个线程进行处理。但是如果这个连接不做任何事情就会造成不必要的线程开销，当然可以通过线程池机制改善这个缺点。I&#x2F;O 的局限是它是面向流的、阻塞式的、串行的一个过程。对每一个客户端的 Socket 连接 I&#x2F;O 都需要一个线程来处理，而且在此期间，这个线程一直被占用，直到 Socket 关闭。在这期间，TCP 的连接、数据的读取、数据的返回都是被阻塞的。也就是说这期间大量浪费了 CPU 的时间片和线程占用的内存资源。此外，每建立一个 Socket 连接时，同时创建一个新线程对该 Socket 进行单独通信 (采用阻塞的方式通信)。这种方式具有很快的响应速度，并且控制起来也很简单。在连接数较少的时候非常有效，但是如果对每一个连接都产生一个线程无疑是对系统资源的一种浪费，如果连接数较多将会出现资源不足的情况；</li>
<li>同步非阻塞 (NIO 方法)：服务器实现模式为一个请求启动一个线程，每个线程亲自处理 I&#x2F;O，但是另外的线程轮询检查是否 I&#x2F;O 准备完毕，不必等待 I&#x2F;O 完成，即客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到连接有 I&#x2F;O 请求时才启动一个线程进行处理。NIO 则是面向缓冲区，非阻塞式的，基于选择器的，用一个线程来轮询监控多个数据传输通道，哪个通道准备好了 (即有一组可以处理的数据) 就处理哪个通道。服务器端保存一个 Socket 连接列表，然后对这个列表进行轮询，如果发现某个 Socket 端口上有数据可读时，则调用该 Socket 连接的相应读操作；如果发现某个 Socket 端口上有数据可写时，则调用该 Socket 连接的相应写操作；如果某个端口的 Socket 连接已经中断，则调用相应的析构方法关闭该端口。这样能充分利用服务器资源，效率得到大幅度提高；</li>
<li>异步非阻塞 (AIO 方法，JDK7 发布)：服务器实现模式为一个有效请求启动一个线程，客户端的 I&#x2F;O 请求都是由操作系统先完成了再通知服务器应用去启动线程进行处理，每个线程不必亲自处理 I&#x2F;O，而是委派操作系统来处理，并且也不需要等待 I&#x2F;O 完成，如果完成了操作系统会另行通知的。该模式采用了 Linux 的 epoll 模型。</li>
</ol>
<ul>
<li>在连接数不多的情况下，传统 I&#x2F;O 模式编写较为容易，使用上也较为简单。但是随着连接数的不断增多，传统 I&#x2F;O 处理每个连接都需要消耗一个线程，而程序的效率，当线程数不多时是随着线程数的增加而增加，但是到一定的数量之后，是随着线程数的增加而减少的。所以传统阻塞式 I&#x2F;O 的瓶颈在于不能处理过多的连接。非阻塞式 I&#x2F;O 出现的目的就是为了解决这个瓶颈。非阻塞 IO 处理连接的线程数和连接数没有联系，例如系统处理 10000 个连接，非阻塞 I&#x2F;O 不需要启动 10000 个线程，你可以用 1000 个，也可以用 2000 个线程来处理。因为非阻塞 IO 处理连接是异步的，当某个连接发送请求到服务器，服务器把这个连接请求当作一个请求“事件”，并把这个“事件”分配给相应的函数处理。我们可以把这个处理函数放到线程中去执行，执行完就把线程归还，这样一个线程就可以异步的处理多个事件。而阻塞式 I&#x2F;O 的线程的大部分时间都被浪费在等待请求上了。</li>
</ul>
<h3 id="AIO-相关的类和接口"><a href="#AIO-相关的类和接口" class="headerlink" title="AIO 相关的类和接口"></a>AIO 相关的类和接口</h3><ul>
<li><code>java.nio.channels.AsynchronousChannel</code>：标记一个 Channel 支持异步 IO 操作；</li>
<li><code>java.nio.channels.AsynchronousServerSocketChannel</code>：ServerSocket 的 AIO 版本，创建 TCP 服务端，绑定地址，监听端口等；</li>
<li><code>java.nio.channels.AsynchronousSocketChannel</code>：面向流的异步 Socket Channel，表示一个连接；</li>
<li><code>java.nio.channels.AsynchronousChannelGroup</code>：异步 Channel 的分组管理，目的是为了资源共享。一个 AsynchronousChannelGroup 绑定一个线程池，这个线程池执行两个任务：处理 IO 事件和派发 CompletionHandler。AsynchronousServerSocketChannel 创建的时候可以传入一个 AsynchronousChannelGroup，那么通过 AsynchronousServerSocketChannel 创建的 AsynchronousSocketChannel 将同属于一个组，共享资源；</li>
<li><code>java.nio.channels.CompletionHandler</code>：异步 IO 操作结果的回调接口，用于定义在 IO 操作完成后所作的回调工作。AIO 的 API 允许两种方式来处理异步操作的结果：返回的 Future 模式或者注册 CompletionHandler，推荐用 CompletionHandler 的方式，这些 handler 的调用是由 AsynchronousChannelGroup 的线程池派发的。这里线程池的大小是性能的关键因素。</li>
</ul>
<h3 id="Reactor线程模型"><a href="#Reactor线程模型" class="headerlink" title="Reactor线程模型"></a>Reactor线程模型</h3><p>常用的Reactor线程模型有三种，分别如下：</p>
<ol>
<li>Reactor单线程模型；</li>
<li>Reactor多线程模型；</li>
<li>主从Reactor多线程模型    <ul>
<li>Netty的线程模型并非固定不变，通过在启动辅助类中创建不同的EventLoopGroup实例并通过适当的参数配置，就可以支持上述三种Reactor线程模型。</li>
</ul>
</li>
</ol>
<h3 id="Netty线程模型"><a href="#Netty线程模型" class="headerlink" title="Netty线程模型"></a>Netty线程模型</h3><ul>
<li><a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/netty-threading-model">http://www.infoq.com/cn/articles/netty-threading-model</a></li>
<li>主从Reactor线程模型</li>
<li>Netty线程开发最佳实践<ul>
<li>2.4.1. 时间可控的简单业务直接在IO线程上处理<br>  如果业务非常简单，执行时间非常短，不需要与外部网元交互、访问数据库和磁盘，不需要等待其它资源，则建议直接在业务ChannelHandler中执行，不需要再启业务的线程或者线程池。避免线程上下文切换，也不存在线程并发问题。</li>
<li>2.4.2. 复杂和时间不可控业务建议投递到后端业务线程池统一处理<br>  对于此类业务，不建议直接在业务ChannelHandler中启动线程或者线程池处理，建议将不同的业务统一封装成Task，统一投递到后端的业务线程池中进行处理。<br>  过多的业务ChannelHandler会带来开发效率和可维护性问题，不要把Netty当作业务容器，对于大多数复杂的业务产品，仍然需要集成或者开发自己的业务容器，做好和Netty的架构分层。</li>
<li>2.4.3. 业务线程避免直接操作ChannelHandler<br>  对于ChannelHandler，IO线程和业务线程都可能会操作，因为业务通常是多线程模型，这样就会存在多线程操作ChannelHandler。为了尽量避免多线程并发问题，建议按照Netty自身的做法，通过将操作封装成独立的Task由NioEventLoop统一执行，而不是业务线程直接操作<br>  <code>ctx.executor().execute(new Runnable()&#123;&#125;)</code><br>  如果你确认并发访问的数据或者并发操作是安全的，则无需多此一举，这个需要根据具体的业务场景进行判断，灵活处理。</li>
</ul>
</li>
</ul>
<h3 id="Netty的“零拷贝”"><a href="#Netty的“零拷贝”" class="headerlink" title="Netty的“零拷贝”"></a>Netty的“零拷贝”</h3><ul>
<li>Netty的接收和发送ByteBuffer采用DIRECT BUFFERS，使用堆外直接内存进行Socket读写，不需要进行字节缓冲区的二次拷贝。</li>
<li>Netty提供了组合Buffer对象，可以聚合多个ByteBuffer对象，用户可以像操作一个Buffer那样方便的对组合Buffer进行操作，避免了传统通过内存拷贝的方式将几个小Buffer合并成一个大的Buffer。</li>
<li>Netty的文件传输采用了transferTo方法，它可以直接将文件缓冲区的数据发送到目标Channel，避免了传统通过循环write方式导致的内存拷贝问题。</li>
</ul>
<h3 id="Netty-灵活的TCP参数配置能力"><a href="#Netty-灵活的TCP参数配置能力" class="headerlink" title="Netty - 灵活的TCP参数配置能力"></a>Netty - 灵活的TCP参数配置能力</h3><ul>
<li>SO_RCVBUF和SO_SNDBUF：通常建议值为128K或者256K；</li>
<li>SO_TCPNODELAY：NAGLE算法通过将缓冲区内的小封包自动相连，组成较大的封包，阻止大量小封包的发送阻塞网络，从而提高网络应用效率。但是对于时延敏感的应用场景需要关闭该优化算法；</li>
<li>软中断：如果Linux内核版本支持RPS（2.6.35以上版本），开启RPS后可以实现软中断，提升网络吞吐量。RPS根据数据包的源地址，目的地址以及目的和源端口，计算出一个hash值，然后根据这个hash值来选择软中断运行的cpu，从上层来看，也就是说将每个连接和cpu绑定，并通过这个hash值，来均衡软中断在多个cpu上，提升网络并行处理性能。</li>
</ul>
<h3 id="心跳实现"><a href="#心跳实现" class="headerlink" title="心跳实现"></a>心跳实现</h3><ul>
<li>使用TCP协议层的Keeplive机制，但是该机制默认的心跳时间是2小时，依赖操作系统实现不够灵活</li>
<li>应用层实现自定义心跳机制，比如Netty实现心跳机制<ul>
<li>服务端添加IdleStateHandler心跳检测处理器，并添加自定义处理Handler类实现userEventTriggered()方法作为超时事件的逻辑处理</li>
</ul>
</li>
</ul>
<h3 id="Netty中比较常用的帧解码器"><a href="#Netty中比较常用的帧解码器" class="headerlink" title="Netty中比较常用的帧解码器"></a>Netty中比较常用的帧解码器</h3><ol>
<li>固定长度帧解码器 - FixedLengthFrameDecoder<ul>
<li>适用场景：每个上层数据包的长度，都是固定的，比如 100。在这种场景下，只需要把这个解码器加到 pipeline 中，Netty 会把底层帧，拆分成一个个长度为 100 的数据包 (ByteBuf)，发送到下一个 channelHandler入站处理器。</li>
</ul>
</li>
<li>行分割帧解码器 - LineBasedFrameDecoder<ul>
<li>适用场景：每个上层数据包，使用换行符或者回车换行符做为边界分割符。发送端发送的时候，每个数据包之间以换行符&#x2F;回车换行符作为分隔。在这种场景下，只需要把这个解码器加到 pipeline 中，Netty 会使用换行分隔符，把底层帧分割成一个一个完整的应用层数据包，发送到下一站。前面的例子，已经对这个解码器进行了演示。</li>
</ul>
</li>
<li>自定义分隔符帧解码器 - DelimiterBasedFrameDecoder<ul>
<li>DelimiterBasedFrameDecoder 是LineBasedFrameDecoder的通用版本。不同之处在于，这个解码器，可以自定义分隔符，而不是局限于换行符。如果使用这个解码器，在发送的时候，末尾必须带上对应的分隔符。</li>
</ul>
</li>
<li>自定义长度帧解码器 - LengthFieldBasedFrameDecoder<ul>
<li>这是一种基于灵活长度的解码器。在数据包中，加了一个长度字段（长度域），保存上层包的长度。解码的时候，会按照这个长度，进行上层ByteBuf应用包的提取。</li>
<li>LengthFieldPrepender(编码)：如果协议中的第一个字段为长度字段，netty提供了LengthFieldPrepender编码器，它可以计算当前待发送消息的二进制字节长度，将该长度添加到ByteBuf的缓冲区头中</li>
</ul>
</li>
</ol>
<h3 id="Netty-API"><a href="#Netty-API" class="headerlink" title="Netty API"></a>Netty API</h3><h4 id="JDK-ByteBuffer-VS-Netty-ByteBuf"><a href="#JDK-ByteBuffer-VS-Netty-ByteBuf" class="headerlink" title="JDK ByteBuffer VS Netty ByteBuf"></a>JDK ByteBuffer VS Netty ByteBuf</h4><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013828625/article/details/79845512">https://blog.csdn.net/u013828625/article/details/79845512</a></li>
<li>Netty中的ByteBuf则完全对JDK中的ByteBuffer的缺点进行了改进</li>
<li>网络数据的基本单位永远是 byte(字节)。Java NIO 提供 ByteBuffer 作为字节的容器，但该类过于复杂，有点难用。ByteBuf是Netty当中的最重要的工具类，它与JDK的ByteBuffer原理基本上相同，也分为堆内与堆外俩种类型，但是ByteBuf做了极大的优化，具有更简单的API，更多的工具方法和优秀的内存池设计。</li>
<li>ByteBuf 维护俩不同索引：一个用于读取，一个用于写入：从 ByteBuf 读取时，其 readerIndex 将会被递增已经被读取的字节数；当写入 ByteBuf 时，writerIndex 也会被递增</li>
</ul>
<h4 id="SimpleChannelInboundHandler"><a href="#SimpleChannelInboundHandler" class="headerlink" title="SimpleChannelInboundHandler"></a>SimpleChannelInboundHandler</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ffaiss/p/9843442.html">SimpleChannelInboundHandler与ChannelInboundHandlerAdapter</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/97235">Netty随记之ChannelInboundHandlerAdapter、SimpleChannelInboundHandler</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lemon-flm/p/7813914.html">Netty——高级发送和接收数据handler处理器</a></li>
<li>每一个Handler都一定会处理出站或者入站（也可能两者都处理）数据，例如对于入站的Handler可能会继承SimpleChannelInboundHandler或者ChannelInboundHandlerAdapter，而SimpleChannelInboundHandler又是继承于ChannelInboundHandlerAdapter，最大的区别在于SimpleChannelInboundHandler会对没有外界引用的资源进行一定的清理，并且入站的消息可以通过泛型来规定。</li>
<li>对于两者关系：<br><code>public abstract class SimpleChannelInboundHandler&lt;I&gt; extends ChannelInboundHandlerAdapter</code></li>
<li><code>public void channelRead(ChannelHandlerContext ctx, Object msg) </code> , msg 是ByteBuf类型（未decode转化类型的情况），使用 SimpleChannelInboundHandler 会被自动释放</li>
</ul>
<ol>
<li>ChannelInboundHandlerAdapter<ul>
<li>ChannelInboundHandlerAdapter是ChannelInboundHandler的一个简单实现，默认情况下不会做任何处理，只是简单的将操作通过fire*方法传递到ChannelPipeline中的下一个ChannelHandler中让链中的下一个ChannelHandler去处理。</li>
<li>需要注意的是信息经过channelRead方法处理之后不会自动释放（因为信息不会被自动释放所以能将消息传递给下一个ChannelHandler处理）。</li>
</ul>
</li>
<li>SimpleChannelInboundHandler<ul>
<li>SimpleChannelInboundHandler支持泛型的消息处理，默认情况下消息处理完将会被自动释放，无法提供fire*方法传递给ChannelPipeline中的下一个ChannelHandler,如果想要传递给下一个ChannelHandler需要调用ReferenceCountUtil#retain方法。</li>
<li>channelRead0方法在将来将会重命名为messageReceived</li>
</ul>
</li>
</ol>
<h4 id="channelRead-和channelReadComplete"><a href="#channelRead-和channelReadComplete" class="headerlink" title="channelRead()和channelReadComplete()"></a>channelRead()和channelReadComplete()</h4><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000018753423">channelRead()和channelReadComplete() 方法的区别是什么？</a></li>
<li>channelRead表示接收消息，可以看到msg转换成了ByteBuf，然后打印，也就是把Client传过来的消息打印了一下，你会发现每次打印完后，channelReadComplete也会调用，如果你试着传一个超长的字符串过来，超过1024个字母长度，你会发现channelRead会调用多次，而channelReadComplete只调用一次。</li>
</ul>
<h4 id="ctx-write-vd-ctx-channel-write"><a href="#ctx-write-vd-ctx-channel-write" class="headerlink" title="ctx.write() vd ctx.channel().write()"></a>ctx.write() vd ctx.channel().write()</h4><ul>
<li>Any difference between ctx.write() and ctx.channel().write() in netty?:<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20366418/any-difference-between-ctx-write-and-ctx-channel-write-in-netty">https://stackoverflow.com/questions/20366418/any-difference-between-ctx-write-and-ctx-channel-write-in-netty</a></li>
<li>Yes there is… Channel.write(..) always start from the tail of the ChannelPipeline and so pass through all the ChannelOutboundHandlers. ChannelHandlerContext.write(…) starts from the current position of the ChannelHandler which is bound to the ChannelHandlerContext and so only pass those ChannelOutboundHandlers that are in front of it.</li>
</ul>
<h4 id="自定义消息协议"><a href="#自定义消息协议" class="headerlink" title="自定义消息协议"></a>自定义消息协议</h4><ul>
<li><p>len : 表示消息的长度,通常用4个字节保存</p>
</li>
<li><p>head : 消息头部</p>
</li>
<li><p>body : 消息内容</p>
</li>
<li><p>在实际的项目中,消息格式可能会增加一些标志,例如,开始标记,结束标志,消息序列号,消息的协议类型(json或者二进制等)</p>
</li>
</ul>
<h3 id="Netty-没用JDK1-7的AIO"><a href="#Netty-没用JDK1-7的AIO" class="headerlink" title="Netty 没用JDK1.7的AIO"></a>Netty 没用JDK1.7的AIO</h3><ul>
<li>为什么Netty不用AIO而用NIO?</li>
</ul>
<pre>
According to the book the main reasons were:
1. Not faster than NIO (epoll) on unix systems (which is true)
There is no daragram suppport
2. Unnecessary threading model (too much abstraction without usage)
3. I agree that AIO will not easily replace NIO, but it is useful for windows developers nonetheless.
<https: 2515 github.com netty issues>
We obviously did not consider Windows as a serious platform so far, and that's why we were neglecting NIO.2 AIO API which was implemented using IOCP on Windows. (On Linux, it wasn't any faster because it was using the same OS facility - epoll.)
</https:></pre>

<h3 id="Netty-Epoll"><a href="#Netty-Epoll" class="headerlink" title="Netty-Epoll"></a>Netty-Epoll</h3><ul>
<li>Selector 实现原理:<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/2b71ea919d49">http://www.jianshu.com/p/2b71ea919d49</a></li>
</ul>
<ul>
<li>epoll的两种工作模式：<ul>
<li>LT：level-trigger，水平触发模式，只要某个socket处于readable&#x2F;writable状态，无论什么时候进行epoll_wait都会返回该socket。<br>  当epoll_wait检测到描述符事件发生并将此事件通知应用程序，应用程序可以不立即处理该事件。下次调用epoll_wait时，会再次响应应用程序并通知此事件。</li>
<li>ET：edge-trigger，边缘触发模式，只有某个socket从unreadable变为readable或从unwritable变为writable时，epoll_wait才会返回该socket。<br>  当epoll_wait检测到描述符事件发生并将此事件通知应用程序，应用程序必须立即处理该事件。如果不处理，下次调用epoll_wait时，不会再次响应应用程序并通知此事件。<br>  ET模式在很大程度上减少了epoll事件被重复触发的次数，因此效率要比LT模式高。epoll工作在ET模式的时候，必须使用非阻塞套接口，以避免由于一个文件句柄的阻塞读&#x2F;阻塞写操作把处理多个文件描述符的任务饿死。</li>
</ul>
</li>
<li>在Linux系统中JDK NIO使用的是 LT ，而Netty epoll使用的是 ET。</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>JDK中有自带的ByteBuffer类，但是netty中的 ByteBuf 算是对Byte Buffer的重新实现。他们没有关联关系。</li>
<li>netty推荐使用<code>io.netty.buffer.Unpooled</code>来进行Buff的创建工作。Unpooled是一个工具类，可以为ByteBuf分配空间、拷贝或者封装操作</li>
<li>DirectBuffer：使用 DirectBuffer 是一种更加接近系统底层的方法，所以，它的速度比普通的 ByteBuffer 更快。DirectBuffer 相对于 ByteBuffer 而言，读写访问速度快很多，但是创建和销毁 DirectBuffer 的花费却比 ByteBuffer 高。</li>
<li>Netty的并发处理能力主要体现在两个方面：<ol>
<li>利用Java语言自身的多线程机制实现消息的并行处理；</li>
<li>利用Java NIO类库的Selector实现多路复用，一个NIO线程可以同时并发处理成百上千个通信链路，实现海量客户端的并发接入和处理。</li>
</ol>
</li>
<li>netty.pipeline执行顺序：在给定的示例配置中，当事件进入到入站时，处理程序计算顺序为(代码行：从上到下)。当一个事件出站时，顺序是(代码行：从下到上)。</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/netty-high-performance">Netty系列之Netty高性能之道</a>  </li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/linsongbin1/article/details/77915686">Netty实战-自定义解码器处理半包消息</a></li>
<li>TODO nio-demo&#x2F;docs</li>
<li>TODO nio_demo&#x2F;netty-definitive-guide&#x2F;netty-definitive-guide-notes.md</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/01/14/20220114-ru-he-zuo-shu-ju-ku-qian-yi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/01/14/20220114-ru-he-zuo-shu-ju-ku-qian-yi/" itemprop="url">如何做数据库迁移</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-01-14T11:26:02+08:00">
                2022-01-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先抛出以下问题：<br>把MHA-1集群的Database-C 迁到 MHA-2 集群中，有没有简单高效的方案?<br><img src="/2022/01/14/20220114-ru-he-zuo-shu-ju-ku-qian-yi/migration.png"></p>
<hr>
<ul>
<li>方案1、在两个MHA集群，在建一套MHA3。MHA2的主作为MHA1的从？这样MH3切换的时候，应用服务就可以直接感知切到新库了；</li>
<li>方案2、先把C同步到2集群，然后做otter同步</li>
</ul>
<hr>
<ul>
<li>方案1： 存在的问题：<ul>
<li>中间再搞一套MHA，不是运维麻烦，而是多了一套中间库，可能会导致MHA的切换逻辑紊乱。</li>
</ul>
</li>
<li>方案2： <ul>
<li>业务方的服务要自行选择数据源进行切换 （流量低且数据一致性要求不高，考虑通过开关切换；否则需考虑停服等其他方案）</li>
<li>otter双向同步，业务最好同时只写一边（要注意旧库是否有自增主键；同步冲突策略设置，默认会冲突会同步中断）</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/27/20211027-raft-xue-xi-bi-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拉巴力的纸皮箱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/10/27/20211027-raft-xue-xi-bi-ji/" itemprop="url">raft学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-27T10:42:07+08:00">
                2021-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>Raft将共识问题分解三个子问题：</p>
<ol>
<li>Leader election 领导选举：有且仅有一个leader节点，如果leader宕机，通过选举机制选出新的leader；</li>
<li>Log replication 日志复制：leader从客户端接收数据更新&#x2F;删除请求，然后日志复制到follower节点，从而保证集群数据的一致性；</li>
<li>Safety 安全性：通过安全性原则来处理一些特殊case，保证Raft算法的完备性；</li>
</ol>
</li>
<li><p>所以，Raft算法核心流程可以归纳为：</p>
<ul>
<li>首先选出leader，leader节点负责接收外部的数据更新&#x2F;删除请求；</li>
<li>然后日志复制到其他follower节点，同时通过安全性的准则来保证整个日志复制的一致性；</li>
<li>如果遇到leader故障，followers会重新发起选举出新的leader；</li>
</ul>
</li>
<li><p>Raft规定：只有拥有最新提交日志的follower节点才有资格成为leader节点。具体做法：candidate竞选投票时会携带最新提交日志，follower会用自己的日志和candidate做比较。</p>
</li>
<li><p>因为日志提交需要超过半数的节点同意，所以针对日志同步落后的follower（还未同步完全部日志，导致落后于其他节点）在竞选leader的时候，肯定拿不到超过半数的票，也只有那些完成同步的才有可能获取超过半数的票成为leader。</p>
</li>
<li><p>日志更新判断方式是比较日志项的term和index：</p>
<ul>
<li>如果TermId不同，选择TermId最大的；</li>
<li>如果TermId相同，选择Index最大的；</li>
</ul>
</li>
<li><p>Raft对日志提交有额外安全机制：leader只能提交当前任期Term的日志，旧任期Term（以前的数据）只能通过当前任期Term的数据提交来间接完成提交。简单的说，日志提交有两个条件需要满足：</p>
<ul>
<li>当前任期；</li>
<li>复制结点超过半数；</li>
</ul>
</li>
<li><p>Raft在日志项提交上增加了限制：只有当前任期且复制超过半数的日志才可以提交。</p>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/obnZm2Lhf_rKla2AxbrBlg">分布式一致性算法Raft</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/zMnqOCUVvRLQuJUwvM3QRA">Raft 一致性算法论文中文译文</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/">&lt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/9/">&gt;</a>
  </nav>





          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
<a href="/archives/">                
<!--<a href="/archives/%7C%7C%20archive">-->
              
                  <span class="site-state-item-count">147</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">159</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kingson Wu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
