---
title: 记一次socket泄露问题排查记录
date: 2023-07-30 13:03:45
tags: [TCP, CLOSED]
---

![](20230730-记一次socket泄露问题排查记录/socket数量暴涨.png)


+ 在 ss -s 命令的输出中，"closed" 表示已关闭的 TCP 连接的数量。

>>具体地，TCP 的 "closed" 状态表示连接已经关闭，不再使用，并且不再具有任何网络连接或状态信息。这些连接处于已经结束的状态，但它们的套接字资源还未被完全释放或回收。

>>在输出结果中，"closed" 数量是指当前处于已关闭状态的 TCP 连接的数量。这些连接可能是先前已经建立的连接，已经完成了其通信任务，双方都关闭了连接，并且连接的套接字资源等待系统进行资源回收。

>>需要注意的是，已关闭的连接数量的增加和减少是动态的，因为在系统的运行过程中，套接字的打开和关闭是常见的网络操作。


+ [tcp-socket文件句柄泄漏](http://mdba.cn/2015/03/10/tcp-socket%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E6%B3%84%E6%BC%8F/)

+ `lsof| grep "can't identify protocol"`
如果存在很多，则代表socket泄漏，同时会显示哪个进程使用的sock未关闭。

+ 相关排查命令

<pre>
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
 
sudo lsof | grep sock | awk '{++S[$1]} END {for(a in S) print a, S[a]}' | sort -k2 -nr
sudo lsof | awk '/sock/ {++S[substr($0, index($0, $9))]} END {for(a in S) print a, S[a]}'
sudo lsof | grep sock|grep 'identify protocol'|awk ' {++S[$2]} END {for(a in S) print a, S[a]}'| sort -k2 -nr
</pre>


![](20230730-记一次socket泄露问题排查记录/identify protocol.png)

![](20230730-记一次socket泄露问题排查记录/process.png)
![](20230730-记一次socket泄露问题排查记录/process2.png)


+ nginx和gateway都reload，那么nginx会产生新的worker进程，但是应该shutdown的老进程因为和gateway还有连接，所以也不会销毁，这样时间长了会有很多处于shutting状态的进程，这些进程都会占用资源。